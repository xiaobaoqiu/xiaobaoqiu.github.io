
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>动态数据源 - xiaobaoqiu Blog</title>
  <meta name="author" content="xiaobaoqiu">

  
  <meta name="description" content="1.数据库层面的动态数据源 比如多个读库(Read),可以配置一个虚拟IP,每次读数据库的请求被均衡的分配到各个读库(使用Keepalived等). 这中方式对应用程序是透明的. 2.数据库Proxy 很多现成的数据库Proxy,在Proxy中可以做负载均衡(一般使用LVS, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xiaobaoqiu.github.io/blog/2015/06/02/dong-tai-shu-ju-yuan/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link href="/atom.xml" rel="alternate" title="xiaobaoqiu Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">xiaobaoqiu Blog</a></h1>
  
    <h2>Keep Runnnnnnnnnning...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="xiaobaoqiu@163.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="xiaobaoqiu.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有博文</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">动态数据源</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-02T02:42:35+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>2:42 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>1.数据库层面的动态数据源</h1>

<p>比如多个读库(Read),可以配置一个虚拟IP,每次读数据库的请求被均衡的分配到各个读库(使用Keepalived等).</p>

<p>这中方式对应用程序是透明的.</p>

<h1>2.数据库Proxy</h1>

<p>很多现成的数据库Proxy,在Proxy中可以做负载均衡(一般使用LVS,Keepalived等现成应用),权限验证,过滤,业务缓存等控制逻辑.比如:</p>

<pre><code>1.360基于mysql-proxy的Atlas
Atlas是由 Qihoo 360,Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。它是在mysql-proxy 0.8.2版本的基础上，对其进行了优化，增加了一些新的功能特性。360内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。
github:https://github.com/Qihoo360/Atlas
参考:https://github.com/Qihoo360/Atlas/wiki/Atlas%E7%9A%84%E6%9E%B6%E6%9E%84

2.阿里的DRDS
分布式关系型数据库服务（Distribute Relational Database Service，简称DRDS）是一种水平拆分、可平滑扩缩容、读写分离的在线分布式数据库服务。前身为淘宝开源的TDDL，是近千个应用首选组件，已稳定服务了七年以上。已经商业化.
参考:http://docs.aliyun.com/?spm=5176.7622920.9.2.qGx2nq#/pub/drds/brief-manual/summary&amp;summary

3.网易的分布式数据库中间件DDB
DDB（Distributed database）是网易杭研院立项最早，应用最为广泛的后台产品之一，也是国内最早出现的基于现有database之上开发的分布式数据库中间件，目前依然在为网易易信，云音乐，云阅读等大型互联网产品提供稳定的数据库服务。
参考:http://www.majin163.com/2014/09/24/ddb-introduce/

4.百度DDBS
</code></pre>

<h1>3.代码层面</h1>

<p>使用Spring实现数据源动态配置,可以在代码层面达到Master-Slave数据库分离的效果.</p>

<p>其实原理很简单,需要做两个工作:</p>

<pre><code>1.实现一个根据不同key使用不同实际DataSource的自定义DataSource;
2.在请求的ThreadLocal中保存当前请求需要使用的数据库的key;
</code></pre>

<p>其中第一个工作Spring已经帮我们做了,见类org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource.</p>

<h3>3.1 AbstractRoutingDataSource简介</h3>

<p>下面简单介绍这个类:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 抽象的javax.sql.DataSource实现，可以完成基于一个查找key来路由 #getConnection()到某些特性目标DataSourcesd的一个。一般通过绑定线程上下文来决定。
</span><span class='line'> */
</span><span class='line'>public abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean {
</span><span class='line'>private Map&lt;Object, Object&gt; targetDataSources;
</span><span class='line'>
</span><span class='line'>    private Object defaultTargetDataSource;
</span><span class='line'>
</span><span class='line'>    private boolean lenientFallback = true;
</span><span class='line'>
</span><span class='line'>    private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup();
</span><span class='line'>
</span><span class='line'>    private Map&lt;Object, DataSource&gt; resolvedDataSources;
</span><span class='line'>
</span><span class='line'>    private DataSource resolvedDefaultDataSource;
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 设置目标DataSources的map映射，其中查找key作为 map的key。
</span><span class='line'>     * 这个映射的value可以是对象的DataSource实例，或者是一个数据源name的字符串（可以被DataSourceLookup解析）。
</span><span class='line'>     *
</span><span class='line'>     * key可以是任意的类型，只要实现了普通的查找处理。
</span><span class='line'>     * 具体的key表示形式，将会被resolveSpecifiedLookupKey和determineCurrentLookupKey处理
</span><span class='line'>     *
</span><span class='line'>     */
</span><span class='line'>    public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) {
</span><span class='line'>        this.targetDataSources = targetDataSources;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 设置默认目标数据源。如果我们在map中找不到对应的key时，则会使用这里设置的默认数据源
</span><span class='line'>     */
</span><span class='line'>    public void setDefaultTargetDataSource(Object defaultTargetDataSource) {
</span><span class='line'>        this.defaultTargetDataSource = defaultTargetDataSource;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 指定默认的DataSource，当通过指定的查找key不能找到对应的DataSource。
</span><span class='line'>     * 如果为false，则直接返回失败，如果为true，则使用默认的数据源。默认为true
</span><span class='line'>     */
</span><span class='line'>    public void setLenientFallback(boolean lenientFallback) {
</span><span class='line'>        this.lenientFallback = lenientFallback;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 设置DataSourceLookup的实现类，该实现类可以把字符串配置的数据源，解析成我们需要的DataSource类.默认使用JndiDataSourceLookup。
</span><span class='line'>     *
</span><span class='line'>     * JndiDataSourceLookup方法使用ref bean方式获取配置文件中配置的dataSource数据源，也就是我们一般使用xml中配置datasource的方式就是jndi。
</span><span class='line'>     */
</span><span class='line'>    public void setDataSourceLookup(DataSourceLookup dataSourceLookup) {
</span><span class='line'>        this.dataSourceLookup = (dataSourceLookup != null ? dataSourceLookup : new JndiDataSourceLookup());
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>    * 初始化,将targetDataSources转换成resolvedDataSources
</span><span class='line'>    */
</span><span class='line'>    public void afterPropertiesSet() {
</span><span class='line'>        if (this.targetDataSources == null) {
</span><span class='line'>            throw new IllegalArgumentException("Property 'targetDataSources' is required");
</span><span class='line'>        }
</span><span class='line'>        this.resolvedDataSources = new HashMap&lt;Object, DataSource&gt;(this.targetDataSources.size());
</span><span class='line'>        for (Map.Entry entry : this.targetDataSources.entrySet()) {
</span><span class='line'>            Object lookupKey = resolveSpecifiedLookupKey(entry.getKey());
</span><span class='line'>            DataSource dataSource = resolveSpecifiedDataSource(entry.getValue());
</span><span class='line'>            this.resolvedDataSources.put(lookupKey, dataSource);
</span><span class='line'>        }
</span><span class='line'>        if (this.defaultTargetDataSource != null) {
</span><span class='line'>            this.resolvedDefaultDataSource = resolveSpecifiedDataSource(this.defaultTargetDataSource);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 根据lookupKey获取map中存放的key值，默认两者是一样的
</span><span class='line'>     */
</span><span class='line'>    protected Object resolveSpecifiedLookupKey(Object lookupKey) {
</span><span class='line'>        return lookupKey;
</span><span class='line'>    }
</span><span class='line'>    /**
</span><span class='line'>     * 转换从获取map中存放的dataSource
</span><span class='line'>     */
</span><span class='line'>    protected DataSource resolveSpecifiedDataSource(Object dataSource) throws IllegalArgumentException {
</span><span class='line'>        if (dataSource instanceof DataSource) {
</span><span class='line'>            return (DataSource) dataSource;
</span><span class='line'>        }
</span><span class='line'>        else if (dataSource instanceof String) {
</span><span class='line'>            return this.dataSourceLookup.getDataSource((String) dataSource);
</span><span class='line'>        }
</span><span class='line'>        else {
</span><span class='line'>            throw new IllegalArgumentException(
</span><span class='line'>                    "Illegal data source value - only [javax.sql.DataSource] and String supported: " + dataSource);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>    * 这里就是抽象类给我们实现的接口方法，根据我们的配置上下文，抽象类决定实现哪个连接
</span><span class='line'>    */
</span><span class='line'>    public Connection getConnection() throws SQLException {
</span><span class='line'>        return determineTargetDataSource().getConnection();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public Connection getConnection(String username, String password) throws SQLException {
</span><span class='line'>        return determineTargetDataSource().getConnection(username, password);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    protected DataSource determineTargetDataSource() {
</span><span class='line'>        Assert.notNull(this.resolvedDataSources, "DataSource router not initialized");
</span><span class='line'>        Object lookupKey = determineCurrentLookupKey();
</span><span class='line'>        DataSource dataSource = this.resolvedDataSources.get(lookupKey);
</span><span class='line'>        if (dataSource == null && (this.lenientFallback || lookupKey == null)) {
</span><span class='line'>            dataSource = this.resolvedDefaultDataSource;
</span><span class='line'>        }
</span><span class='line'>        if (dataSource == null) {
</span><span class='line'>            throw new IllegalStateException("Cannot determine target DataSource for lookup key [" + lookupKey + "]");
</span><span class='line'>        }
</span><span class='line'>        return dataSource;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>    * 这里是我们使用这个抽象类需要实现的方法，主要就是告诉该抽象类，当前需要使用的数据源的key是什么，这样抽象类就可以知道使用哪个数据库连接
</span><span class='line'>    */
</span><span class='line'>    protected abstract Object determineCurrentLookupKey();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我们可以继承这个类实现自己的RoutingDataSource,只需要实现determineCurrentLookupKey()方法.下面是一个实现示例,其中DataSourceKeyHolder用来在ThreadLocal中保存key,而我们的RoutingDataSource就可以从ThreadLocal中获取key来决定使用那个具体的数据源:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class RoutingDataSource extends AbstractRoutingDataSource {
</span><span class='line'>    @Override
</span><span class='line'>    protected Object determineCurrentLookupKey() {
</span><span class='line'>        return DataSourceKeyHolder.getDataSource();
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public class DataSourceKeyHolder {
</span><span class='line'>    private static final ThreadLocal&lt;String&gt; holder = new ThreadLocal&lt;String&gt;();
</span><span class='line'>
</span><span class='line'>    public static String getDataSource() {
</span><span class='line'>        return holder.get();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public static void putDataSource(String value) {
</span><span class='line'>        holder.set(value);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public static void clear(){
</span><span class='line'>        holder.remove();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>3.2 自己实现RoutingDataSource</h3>

<p>Spring自带的AbstractRoutingDataSource功能强大,但是略先麻烦(最终使用的其实只有resolvedDataSources这个Map).我们完全可以自己实现一个简单的RoutingDataSource,比如我们要实现读写分离的动态数据库,一个简单实现如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class RoutingDataSource extends AbstractDataSource implements InitializingBean {
</span><span class='line'>    /**
</span><span class='line'>     * 写库, key是String
</span><span class='line'>     */
</span><span class='line'>    private Map&lt;String, DataSource&gt; writeDataSourceMap;
</span><span class='line'>    /**
</span><span class='line'>     * 读库, key是String
</span><span class='line'>     */
</span><span class='line'>    private Map&lt;String, DataSource&gt; readDataSourceMap;
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public Connection getConnection() throws SQLException {
</span><span class='line'>        //从上下文中获取key
</span><span class='line'>        ConnectionKey connectionKey = ConnectionKeyHolder.get();
</span><span class='line'>        try {
</span><span class='line'>            //默认情况,返回随机一个写库
</span><span class='line'>            if (connectionKey == null) {
</span><span class='line'>                return fetchConnection(writeDataSourceMap, null);
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            //只读
</span><span class='line'>            if (connectionKey.getType().equals(ConnectionKey.READ)) {
</span><span class='line'>                return fetchConnection(readDataSourceMap, connectionKey.getKey());
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            //可读可写
</span><span class='line'>            if (connectionKey.getType().equals(ConnectionKey.READ_WRITE)) {
</span><span class='line'>                return fetchConnection(writeDataSourceMap, connectionKey.getKey());
</span><span class='line'>            }
</span><span class='line'>        } catch (Exception e) {
</span><span class='line'>            logger.error("getConnectionError", e);
</span><span class='line'>            if (e instanceof SQLException) {
</span><span class='line'>                throw (SQLException) e;
</span><span class='line'>            } else {
</span><span class='line'>                throw new SQLException(e);
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        // impossible code
</span><span class='line'>        throw new IllegalArgumentException("invalid connection type: " + connectionKey.getType() + ", key: "
</span><span class='line'>                + connectionKey.getKey());
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 根据key从对应的Map中获取数据库连接
</span><span class='line'>     *
</span><span class='line'>     * @param dbSourceMap
</span><span class='line'>     * @param key
</span><span class='line'>     * @return
</span><span class='line'>     * @throws SQLException
</span><span class='line'>     */
</span><span class='line'>    private Connection fetchConnection(final Map&lt;String, DataSource&gt; dbSourceMap, String key) throws SQLException {
</span><span class='line'>        if (key == null || key.length() == 0) { // null key, return a random read connection
</span><span class='line'>            key = randomKey(dbSourceMap);
</span><span class='line'>        }
</span><span class='line'>        if (dbSourceMap.get(key) == null) {
</span><span class='line'>            key = randomKey(dbSourceMap);
</span><span class='line'>        }
</span><span class='line'>        return dbSourceMap.get(key).getConnection();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 随机获取一个Key
</span><span class='line'>     * @return
</span><span class='line'>     */
</span><span class='line'>    private String randomKey(final Map&lt;String, DataSource&gt; dbSourceMap) {
</span><span class='line'>        String[] keys = dbSourceMap.keySet().toArray(new String[0]);
</span><span class='line'>        int size = dbSourceMap.size();
</span><span class='line'>        int rand = new Random().nextInt(size);
</span><span class='line'>        return keys[rand];
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public Connection getConnection(String username, String password) throws SQLException {
</span><span class='line'>        throw new UnsupportedOperationException();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void afterPropertiesSet() throws Exception {
</span><span class='line'>        Preconditions.checkArgument(MapUtils.isNotEmpty(writeDataSourceMap));
</span><span class='line'>        Preconditions.checkArgument(MapUtils.isNotEmpty(readDataSourceMap));
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setWriteDataSource(Map&lt;String, DataSource&gt; writeDataSourceMap) {
</span><span class='line'>        this.writeDataSourceMap = writeDataSourceMap;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setReadDataSourceMap(Map&lt;String, DataSource&gt; readDataSourceMap) {
</span><span class='line'>        this.readDataSourceMap = readDataSourceMap;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public class ConnectionKey {
</span><span class='line'>    /**
</span><span class='line'>     * 读库,只读
</span><span class='line'>     */
</span><span class='line'>    public static final String READ = "R";
</span><span class='line'>    /**
</span><span class='line'>     * 写库,可读可写
</span><span class='line'>     */
</span><span class='line'>    public static final String READ_WRITE = "RW";
</span><span class='line'>
</span><span class='line'>    private String type;
</span><span class='line'>    private String key;
</span><span class='line'>
</span><span class='line'>    public ConnectionKey() {
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public ConnectionKey(String type, String key) {
</span><span class='line'>        this.type = type;
</span><span class='line'>        this.key = key;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String getType() {
</span><span class='line'>        return type;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String getKey() {
</span><span class='line'>        return key;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setType(String type) {
</span><span class='line'>        this.type = type;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public void setKey(String key) {
</span><span class='line'>        this.key = key;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public class ConnectionKeyHolder {
</span><span class='line'>    private static ThreadLocal&lt;ConnectionKey&gt; connType = new ThreadLocal&lt;ConnectionKey&gt;();
</span><span class='line'>
</span><span class='line'>    public static void set(ConnectionKey type) {
</span><span class='line'>        connType.set(type);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public static ConnectionKey get() {
</span><span class='line'>        return connType.get();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public static void release() {
</span><span class='line'>        connType.remove();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>3.3 使用实现动态数据源</h3>

<p>以我们自己实现的为例子,我们简单展示一下如何使用Spring加上AOP使用我们的动态数据源.</p>

<p>首先定义使用读库和使用写库的注解:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'>* 使用读库的注解,value()代表key
</span><span class='line'>*/
</span><span class='line'>@Target({ ElementType.TYPE, ElementType.METHOD })
</span><span class='line'>@Retention(RetentionPolicy.RUNTIME)
</span><span class='line'>@Documented
</span><span class='line'>public @interface Read {
</span><span class='line'>    String value() default "";
</span><span class='line'>}
</span><span class='line'>/**
</span><span class='line'>* 使用写库的注解,value()代表key
</span><span class='line'>*/
</span><span class='line'>@Target({ ElementType.TYPE, ElementType.METHOD })
</span><span class='line'>@Retention(RetentionPolicy.RUNTIME)
</span><span class='line'>@Documented
</span><span class='line'>public @interface Write {
</span><span class='line'>    String value() default "";
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>然后定义Aspect,逻辑很简单,只是在执行我们的业务逻辑之前给线程上文写入ConnectionKey信息:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class RoutingAop {
</span><span class='line'>
</span><span class='line'>    protected Logger log = LoggerFactory.getLogger(getClass());
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 解析读库的注解
</span><span class='line'>     *
</span><span class='line'>     * @param pjp
</span><span class='line'>     * @param read
</span><span class='line'>     * @return
</span><span class='line'>     * @throws Throwable
</span><span class='line'>     */
</span><span class='line'>    public Object aroundRead(ProceedingJoinPoint pjp, Read read) throws Throwable {
</span><span class='line'>        ConnectionKey origType = ConnectionKeyHolder.get();
</span><span class='line'>        try {
</span><span class='line'>            ConnectionKey newType = ConnectionKey.buildReadConnectionKey(read.value());
</span><span class='line'>            ConnectionKeyHolder.set(newType);
</span><span class='line'>            return pjp.proceed();
</span><span class='line'>        } catch (Throwable throwable) {
</span><span class='line'>            log.warn("error while processing read method", throwable);
</span><span class='line'>            throw throwable;
</span><span class='line'>        } finally {
</span><span class='line'>            if (origType != null) {
</span><span class='line'>                ConnectionKeyHolder.set(origType);
</span><span class='line'>            } else {
</span><span class='line'>                ConnectionKeyHolder.release();
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 解析写库的注解
</span><span class='line'>     *
</span><span class='line'>     * @param pjp
</span><span class='line'>     * @param write
</span><span class='line'>     * @return
</span><span class='line'>     * @throws Throwable
</span><span class='line'>     */
</span><span class='line'>    public Object aroundWrite(ProceedingJoinPoint pjp, Write write) throws Throwable {
</span><span class='line'>        ConnectionKey origType = ConnectionKeyHolder.get();
</span><span class='line'>        try {
</span><span class='line'>            ConnectionKey newType = ConnectionKey.buildWriteConnectionKey(write.value());
</span><span class='line'>            ConnectionKeyHolder.set(newType);
</span><span class='line'>            return pjp.proceed();
</span><span class='line'>        } catch (Throwable throwable) {
</span><span class='line'>            log.warn("error while processing write method", throwable);
</span><span class='line'>            throw throwable;
</span><span class='line'>        } finally {
</span><span class='line'>            if (origType != null) {
</span><span class='line'>                ConnectionKeyHolder.set(origType);
</span><span class='line'>            } else {
</span><span class='line'>                ConnectionKeyHolder.release();
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在Spring配置文件中定义好各个读库和各个写库,定义我们的RoutingDataSource的bean,之后扫描注解就可以了:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!-- DataSource 写库  --&gt;
</span><span class='line'>&lt;bean id="writeDataSource" class="..."&gt;
</span><span class='line'>
</span><span class='line'>&lt;!-- DataSource 读库  --&gt;
</span><span class='line'>&lt;bean id="readDataSource" class="..."&gt;
</span><span class='line'>
</span><span class='line'>&lt;bean id="routingDataSource" class="com.Xxx.RoutingDataSource"&gt;
</span><span class='line'>    &lt;property name="writeDataSourceMap"&gt;
</span><span class='line'>        &lt;map key-type="java.lang.String" value-type="javax.sql.DataSource"&gt;
</span><span class='line'>            &lt;entry key="write1" value-ref="writeDataSource"/&gt;
</span><span class='line'>        &lt;/map&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>    &lt;property name="readDataSourceMap"&gt;
</span><span class='line'>        &lt;map key-type="java.lang.String" value-type="javax.sql.DataSource"&gt;
</span><span class='line'>            &lt;entry key="read1" value-ref="readDataSource"/&gt;
</span><span class='line'>        &lt;/map&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/bean&gt;
</span><span class='line'>
</span><span class='line'>&lt;bean id="routingAop" class="com.Xxx.RoutingAop"/&gt;
</span><span class='line'>&lt;!-- 定义Read Write注解扫描  --&gt;
</span><span class='line'>&lt;aop:config&gt;
</span><span class='line'>    &lt;aop:aspect ref="routingAop"&gt;
</span><span class='line'>        &lt;aop:around method="aroundRead" arg-names="read" pointcut="@annotation(read) &amp;&amp; execution(public * com.Xxx.controller.*.*(..))" /&gt;
</span><span class='line'>    &lt;/aop:aspect&gt;
</span><span class='line'>
</span><span class='line'>    &lt;aop:aspect ref="routingAop"&gt;
</span><span class='line'>        &lt;aop:around method="aroundWrite" arg-names="write" pointcut="@annotation(write) &amp;&amp; execution(public * com.Xxx.controller.*.*(..)) " /&gt;
</span><span class='line'>    &lt;/aop:aspect&gt;
</span><span class='line'>&lt;/aop:config&gt;
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">xiaobaoqiu</span></span>

      




<time class='entry-date' datetime='2015-06-02T02:42:35+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>2:42 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/spring/'>spring</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://xiaobaoqiu.github.io/blog/2015/06/02/dong-tai-shu-ju-yuan/" data-via="" data-counturl="http://xiaobaoqiu.github.io/blog/2015/06/02/dong-tai-shu-ju-yuan/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/05/21/elasticsearchpei-zhi-jie-xi/" title="Previous Post: elasticsearch配置解析">&laquo; elasticsearch配置解析</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/06/03/mysql-innodbsi-suo/" title="Next Post: mysql InnoDB锁和死锁">mysql InnoDB锁和死锁 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <div class="panel-heading">
    <h1 class="panel-title">最新文章</h3>
  </div>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/12/22/protocol-buffers/">Protocol Buffers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/23/memcachedcun-chu-mei-ju/">Memcached存储枚举</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/21/ju-bu-min-gan-hash/">局部敏感Hash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/19/memcachedxian-zhi-fang-wen-ip/">Memcached安全性</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/18/libphonenumber/">Libphonenumber</a>
      </li>
    
  </ul>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">文章分类</h1>
  </div>
  <div id="categories_list_div" class="list-group">
    <li><a class='list-group-item' href='/blog/categories/algorithm/'>algorithm (5)</a></li>
<li><a class='list-group-item' href='/blog/categories/druid/'>druid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/dubbo/'>dubbo (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/guava/'>guava (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/java/'>java (23)</a></li>
<li><a class='list-group-item' href='/blog/categories/library/'>library (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/linux/'>linux (12)</a></li>
<li><a class='list-group-item' href='/blog/categories/maven/'>maven (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/memcached/'>memcached (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/mybatis/'>mybatis (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/mysql/'>mysql (11)</a></li>
<li><a class='list-group-item' href='/blog/categories/octopress/'>octopress (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/postgresql/'>postgresql (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/protobuf/'>protobuf (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/qa/'>qa (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/reading/'>reading (7)</a></li>
<li><a class='list-group-item' href='/blog/categories/search/'>search (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/spring/'>spring (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/squid/'>squid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/structure/'>structure (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tomcat/'>tomcat (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tools/'>tools (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/web/'>web (1)</a></li>
 
  </div>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">其他博客</h3>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://www.baidu.com/p/Nicker_2010'>百度空间</a>
  </div>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - xiaobaoqiu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
