
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>xiaobaoqiu Blog</title>
  <meta name="author" content="xiaobaoqiu">

  
  <meta name="description" content="1.事件处理
2.Listener异常处理
3.Listener注册 1.事件处理 Activiti 内部充斥着各种各样的事件，详见：org.activiti.engine.delegate.event.ActivitiEventType的定义。 在 Activiti 5.15 以前， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xiaobaoqiu.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link href="/atom.xml" rel="alternate" title="xiaobaoqiu Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

  

  
  <meta name="baidu-site-verification" content="5oIt2xaFFz" />
  <meta name="google-site-verification" content="U9Avd5Yqzpetvn_zxo1KaK2iqYNwSlLon27veprwBRY" />
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">xiaobaoqiu Blog</a></h1>
  
    <h2>Think More, Code Less</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="xiaobaoqiu@163.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="xiaobaoqiu.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有博文</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/29/activitishi-jian-chu-li/">Activiti事件处理</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-29T18:39:59+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="#1.%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86">1.事件处理</a></li>
<li><a href="#2.Listener%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">2.Listener异常处理</a></li>
<li><a href="#3.Listener%E6%B3%A8%E5%86%8C">3.Listener注册</a></li>
</ul>


<h2 id="1.事件处理">1.事件处理</h2>


<p>Activiti 内部充斥着各种各样的事件，详见：org.activiti.engine.delegate.event.ActivitiEventType的定义。</p>

<p>在 Activiti 5.15 以前，处理事件需要在流程设计的时候显示的加入各种Listener，比如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    &lt;userTask id="leaderVerifyTask" activiti:taskType="2"&gt;
</span><span class='line'>        &lt;extensionElements&gt;
</span><span class='line'>            &lt;activiti:taskListener event="create" delegateExpression="${taskCreateListener}"/&gt;
</span><span class='line'>            &lt;activiti:taskListener event="assignment" delegateExpression="${taskAssignmentListener}"/&gt;
</span><span class='line'>            &lt;activiti:taskListener event="complete" delegateExpression="${taskCompleteListener}"/&gt;
</span><span class='line'>        &lt;/extensionElements&gt;
</span><span class='line'>    &lt;/userTask&gt;</span></code></pre></td></tr></table></div></figure>


<p>Spring会注入 taskCreateListener 这个bean来作为 leaderVerifyTask 这个任务的创建事件响应逻辑。
这种方式的问题在于，流程设计的时候需要知道 代码中具体的类或者bean的名称，因此无法做到将流程的设计交与开发人员之外的人来做。</p>

<p> 在 Activiti 5.15 中加入了全局的事件监听器 ActivitiEventListener，我们只需要实现一个自己的全局的事件处理器，然后自定义各种事件的处理器。</p>

<pre><code class="`"> /**
 * 流程服务的全局 Listener
 *
 * @author xiaobaoqiu  Date: 16-12-19 Time: 下午7:16
 */
public class GlobalProcessEventListener implements ActivitiEventListener {

    /**
     * 各类 Event 的处理器
     * 其中事件类型参见 ActivitiEventType 定义
     *
     * @see org.activiti.engine.delegate.event.ActivitiEventType
     */
    private Map&lt;ActivitiEventType, ProcessEventHandler&gt; handlers = new HashMap&lt;&gt;();

    @Override
    public void onEvent(ActivitiEvent event) {
        ProcessEventHandler handler = handlers.get(event.getType());
        if (handler != null) {
            handler.handle(event);
        }
    }

    @Override
    public boolean isFailOnException() {
        return false;
    }

    public Map&lt;ActivitiEventType, ProcessEventHandler&gt; getHandlers() {
        return handlers;
    }

    public void setHandlers(Map&lt;ActivitiEventType, ProcessEventHandler&gt; handlers) {
        this.handlers = handlers;
    }
}

/**
 * 流程事件处理
 *
 * @author xiaobaoqiu  Date: 16-12-21 Time: 下午1:33
 */
public interface ProcessEventHandler {

    void handle(ActivitiEvent event);
}
</code></pre>

<p>ActivitiEventListener能做到和流程设计无关，只需要在配置 Activiti 的时候将其注入，并且可以在其中配置能处理哪些类型的事件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;bean id="processEngineConfiguration" class="org.activiti.spring.SpringProcessEngineConfiguration"&gt;
</span><span class='line'>    &lt;property 其他配置 /&gt;
</span><span class='line'>    &lt;property name="eventListeners"&gt;
</span><span class='line'>        &lt;list&gt;
</span><span class='line'>            &lt;ref bean="globalProcessEventListener"/&gt;
</span><span class='line'>        &lt;/list&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/bean&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;!--流程全局事件处理器--&gt;
</span><span class='line'>&lt;bean id="globalProcessEventListener" class="com.qunar.scm.ct.biz.process.event.GlobalProcessEventListener"&gt;
</span><span class='line'>    &lt;property name="handlers"&gt;
</span><span class='line'>        &lt;map&gt;
</span><span class='line'>            &lt;entry key="TASK_CREATED"&gt;
</span><span class='line'>                &lt;bean class="com.qunar.xxx.ProcessProcessTaskCreateListener"/&gt;
</span><span class='line'>            &lt;/entry&gt;
</span><span class='line'>            &lt;entry key="TASK_COMPLETED"&gt;
</span><span class='line'>                &lt;bean class="com.qunar.xxx.ProcessProcessTaskCompleteListener"/&gt;
</span><span class='line'>            &lt;/entry&gt;
</span><span class='line'>            &lt;entry key="TASK_ASSIGNED"&gt;
</span><span class='line'>                &lt;bean class="com.qunar.xxx.ProcessProcessTaskAssignmentListener"/&gt;
</span><span class='line'>            &lt;/entry&gt;
</span><span class='line'>        &lt;/map&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/bean&gt;</span></code></pre></td></tr></table></div></figure>


<p>参考：
<a href="https://www.activiti.org/userguide/index.html#eventDispatcherConfiguration">https://www.activiti.org/userguide/index.html#eventDispatcherConfiguration</a></p>

<h2 id="2.Listener异常处理">2.Listener异常处理</h2>


<p>需要注意的一点是 GlobalProcessEventListener 中的异常处理,我们在实现 GlobalProcessEventListener 的时候,ActivitiEventListener有一个接口需要实现:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return whether or not the current operation should fail when this listeners execution
</span><span class='line'> * throws an exception. 
</span><span class='line'> */
</span><span class='line'>boolean isFailOnException();</span></code></pre></td></tr></table></div></figure>


<p>即当 listener 抛出一个异常的时候,当前操作时序应该失败(其实就是是否需要吞掉 listener 的异常).</p>

<p>我们可以看看 Activiti 相关的源代码,在 ActivitiEventSupport 中的 dispatchEvent 函数,我们可以清晰的看到,listener.isFailOnException()为false则会讲异常吞掉,只是打一行日志.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protected void dispatchEvent(ActivitiEvent event, ActivitiEventListener listener) {
</span><span class='line'>    try {
</span><span class='line'>        listener.onEvent(event);
</span><span class='line'>    } catch (Throwable t) {
</span><span class='line'>        if (listener.isFailOnException()) {
</span><span class='line'>            throw new ActivitiException("Exception while executing event-listener", t);
</span><span class='line'>        } else {
</span><span class='line'>            // Ignore the exception and continue notifying remaining listeners. The
</span><span class='line'>            // listener
</span><span class='line'>            // explicitly states that the exception should not bubble up
</span><span class='line'>            LOG.warn("Exception while executing event-listener, which was ignored", t);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我的建议(也是我现在的做法)是:isFailOnException()设置为true,然后在对应的 ProcessEventHandler 自己处理需要吞掉异常的场景.</p>

<h2 id="3.Listener注册">3.Listener注册</h2>


<p>通常而言,我们的 ProcessEventHandler 需要使用到 Activiti 的Service,比如我的一个简单场景,我需要在 UserTask 获取一些业务信息,新词我需要使用 RuntimeService 来查询一些信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 任务创建事件
</span><span class='line'> *
</span><span class='line'> * @author xiaobaoqiu  Date: 16-12-23 Time: 下午7:09
</span><span class='line'> */
</span><span class='line'>public class ProcessTaskCreateListener extends AbstractProcessTaskListener {
</span><span class='line'>
</span><span class='line'>    @Resource
</span><span class='line'>    private RuntimeService runtimeService;
</span><span class='line'>    ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>按照第一节的写法,就会出现Bean循环依赖的问题:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. ProcessEngineConfiguration 实例创建会触发 GlobalProcessEventListener 创建;
</span><span class='line'>2.GlobalProcessEventListener 实例创建会触发 ProcessProcessTaskCreateListener 创建;
</span><span class='line'>3.ProcessProcessTaskCreateListener 实例创建会触发 RuntimeService 创建;
</span><span class='line'>4.RuntimeService 实例创建依赖 ProcessEngineFactoryBean 创建;
</span><span class='line'>5.ProcessEngineFactoryBean 创建依赖 ProcessEngineConfiguration实例;</span></code></pre></td></tr></table></div></figure>


<p>并且 ProcessEngineFactoryBean 是 Activiti 自己实现的 FactoryBean,用来获得 ProcessEngine 实例 :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class ProcessEngineFactoryBean implements FactoryBean&lt;ProcessEngine&gt;, DisposableBean, ApplicationContextAware {
</span><span class='line'>    ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这个问题一个比较好的解法是, 将 GlobalProcessEventListener 的注册延后到 GlobalProcessEventListener 初始化完成之后,因此涉及到两个问题:</p>

<pre><code>1.GlobalProcessEventListener 什么时机去做自己注册;
2.GlobalProcessEventListener 如何将自己注册到 SpringProcessEngineConfiguration 中;
</code></pre>

<p>其中第一个问题很好回答, GlobalProcessEventListener 自己初始化完成之后去自注册,这个时候依赖的各种Bean已经创建初始化完成了.因此只需要实现 ApplicationContextAware 接口,然后在 setApplicationContext 中做注册的工作.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class GlobalProcessEventListener implements ActivitiEventListener, ApplicationContextAware {
</span><span class='line'>    /**
</span><span class='line'>     * 将当前 EventListener 注册到 Activiti 中
</span><span class='line'>     */
</span><span class='line'>    @Override
</span><span class='line'>    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
</span><span class='line'>        ...
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>第二个问题,如何自己注册上去,这个看看源代码就会找到方法, 我们在配置文件中给 SpringProcessEngineConfiguration 配置 EventListener 调用的其实是 setEventListeners 方法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public void setEventListeners(List&lt;ActivitiEventListener&gt; eventListeners) {
</span><span class='line'>      this.eventListeners = eventListeners;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>我们看远吗发现其中使用 eventListeners 的只有一个地方,就是将其赋值给 ActivitiEventDispatcher</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if(eventListeners != null) {
</span><span class='line'>    for(ActivitiEventListener listenerToAdd : eventListeners) {
</span><span class='line'>        this.eventDispatcher.addEventListener(listenerToAdd);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>而 ActivitiEventDispatcher 才是使用  EventListener 的地方.我们再看源码发现 ActivitiEventDispatcher 提供了 addEventListener 的入口</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public interface ActivitiEventDispatcher {
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Adds an event-listener which will be notified of ALL events by the dispatcher.
</span><span class='line'>     * @param listenerToAdd the listener to add
</span><span class='line'>     */
</span><span class='line'>    void addEventListener(ActivitiEventListener listenerToAdd);
</span><span class='line'>    
</span><span class='line'>    /**
</span><span class='line'>     * Adds an event-listener which will only be notified when an event of the given types occurs.
</span><span class='line'>     * @param listenerToAdd the listener to add
</span><span class='line'>     * @param types types of events the listener should be notified for
</span><span class='line'>     */
</span><span class='line'>    void addEventListener(ActivitiEventListener listenerToAdd, ActivitiEventType... types);</span></code></pre></td></tr></table></div></figure>


<p>并且 SpringProcessEngineConfiguration 有 getEventDispatcher 来获得 ActivitiEventDispatcher 实例,因此我们可以通过 getEventDispatcher 来拿到 ActivitiEventDispatcher 实例,然后将当前的 EventListener 通过 addEventListener 的方法增加到 ActivitiEventDispatcher 的 EventListener 列表中.</p>

<p>因此,最终的实现代码很简单:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 将当前 EventListener 注册到 Activiti 中
</span><span class='line'> */
</span><span class='line'>@Override
</span><span class='line'>public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
</span><span class='line'>    SpringProcessEngineConfiguration configuration = applicationContext.getBean(SpringProcessEngineConfiguration.class);
</span><span class='line'>    configuration.getEventDispatcher().addEventListener(this);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/29/activitiren-wu-zeng-jia-shu-xing/">Activiti任务增加属性</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-29T18:18:20+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="#1.%E4%BB%BB%E5%8A%A1%E5%A2%9E%E5%8A%A0%E5%B1%9E%E6%80%A7">1.任务增加属性</a></li>
</ul>


<p>最近逐步将组内的审核业务迁移到 Activiti 上，为了适配已有业务，需要原生的 Activiti 的用户任务上增加一些属性，比如用户任务(UserTask)增加类型属性等。
Activiti版本为：5.22.0</p>

<h2 id="1.任务增加属性">1.任务增加属性</h2>


<p>下面以增加任务类型为例子，记录修改点：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.修改表结构，ACT_RU_TASK表增加 TASK_TYPE_ 字段
</span><span class='line'>在 activiti-engine 包下，找自己对应的数据库的文件(mysql版本...)
</span><span class='line'>
</span><span class='line'>1.UserTask增加taskType属性
</span><span class='line'>包路径：org.activiti.bpmn.model.UserTask
</span><span class='line'>
</span><span class='line'>3.Task接口增加setTaskType方法
</span><span class='line'>包路径：org.activiti.engine.task.Task
</span><span class='line'>
</span><span class='line'>4.TaskEntity增加taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.persistence.entity.TaskEntity
</span><span class='line'>
</span><span class='line'>5.DelegateTask借口增加 getTaskType 和 setTaskType
</span><span class='line'>包路径：org.activiti.engine.delegate.DelegateTask
</span><span class='line'>
</span><span class='line'>6.TaskDefinition增加taskTypeExpression
</span><span class='line'>包路径：org.activiti.engine.impl.task.TaskDefinition
</span><span class='line'>
</span><span class='line'>7.DynamicBpmnConstants增加USER_TASK_TYPE
</span><span class='line'>包路径：org.activiti.engine.DynamicBpmnConstants
</span><span class='line'>
</span><span class='line'>8.UserTaskActivityBehavior设置taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior
</span><span class='line'>
</span><span class='line'>9.UserTaskParseHandler解析taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.bpmn.parser.handler.UserTaskParseHandler
</span><span class='line'>
</span><span class='line'>10.BpmnXMLConstants增加 ATTRIBUTE_TASK_USER_TYPE
</span><span class='line'>包路径：org.activiti.bpmn.constants.BpmnXMLConstants
</span><span class='line'>
</span><span class='line'>11.UserTaskXMLConverter注册 ATTRIBUTE_TASK_USER_TYPE
</span><span class='line'>包路径：org.activiti.bpmn.converter.UserTaskXMLConverter
</span><span class='line'>
</span><span class='line'>12. Semantic.xsd 文件
</span><span class='line'>包括各个版本的 XSD 文件(XML结构定义)
</span><span class='line'>
</span><span class='line'>13. HistoricTaskWrapper 增加 taskType
</span><span class='line'>包路径：org.activiti.explorer.ui.task.data.HistoricTaskWrapper
</span><span class='line'>
</span><span class='line'>14.HistoricTaskInstanceEntity 增加 taskType
</span><span class='line'>包路径：org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntity
</span><span class='line'>
</span><span class='line'>15. 更多...</span></code></pre></td></tr></table></div></figure>


<p>在自己的API中定义任务类型，然后我们可以修改 activiti-modeler 的相关代码，使得Activiti支持画图时候指定任务类型。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/16/activitibiao/">Activiti表</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-16T16:31:34+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>整理 Activiti 中的表含义，以及一些重要表的字段。本文的 Activiti 版本为 5.22.0</p>

<ul>
<li><a href="#1.%E8%A1%A8%E5%90%AB%E4%B9%89">1.表含义</a></li>
</ul>


<h2 id="1.表含义">1.表含义</h2>


<p>Activiti 中表定义 activiti-engine 这个 module 下，具体位置 /resources/org.activiti/db/create 下，包括各种类型数据库的建表语句，这里我们以Mysql为DB。</p>

<p>首先简单介绍表的前缀的含义，参考官网：<a href="http://www.activiti.org/userguide/index.html#database.tables.explained">http://www.activiti.org/userguide/index.html#database.tables.explained</a></p>

<p>表名称包含三个部分，第一个为所有的表共有的ACT_表示Activiti，第二部分表示表的使用场景</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>ACT_RE_*: RE表示repository，这个前缀的表包含了流程定义和流程静态资源
</span><span class='line'>ACT_RU_*: RU表示runtime，这些运行时的表，包含流程实例，任务，变量，异步任务等运行中的数据。Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。
</span><span class='line'>ACT_ID_*: ID表示identity，这些表包含身份信息，比如用户，组等。
</span><span class='line'>ACT_HI_*: HI表示history，这些表包含历史数据，比如历史流程实例， 变量，任务等。
</span><span class='line'>ACT_GE_*: 通用数据， 用于不同场景下。
</span><span class='line'>ACT_EVT_*: EVT表示EVENT，目前只有一张表ACT_EVT_LOG，存储事件处理日志，方便管理员跟踪处理。</span></code></pre></td></tr></table></div></figure>


<p>下面是各个表的大致意义：</p>

<table>
<thead>
<tr>
<th style="text-align:center;">表 </th>
<th style="text-align:left;"> 意义 </th>
<th style="text-align:left;"> 备注 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">ACT_EVT_LOG         </td>
<td style="text-align:left;"> 事件处理日志 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_GE_BYTEARRAY    </td>
<td style="text-align:left;"> 二进制数据表 </td>
<td style="text-align:left;"> 保存流程定义图片和xml </td>
</tr>
<tr>
<td style="text-align:center;">ACT_GE_PROPERTY     </td>
<td style="text-align:left;"> 属性数据表存储整个流程引擎级别的数据 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_ACTINST      </td>
<td style="text-align:left;"> 历史节点表 </td>
<td style="text-align:left;"> 只记录usertask内容 </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_ATTACHMENT   </td>
<td style="text-align:left;"> 历史附件表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_COMMENT      </td>
<td style="text-align:left;"> 历史意见表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_DETAIL       </td>
<td style="text-align:left;"> 历史详情表，提供历史变量的查询 </td>
<td style="text-align:left;"> 流程中产生的变量详细，包括控制流程流转的变量等</td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_IDENTITYLINK </td>
<td style="text-align:left;"> 历史流程人员表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_PROCINST     </td>
<td style="text-align:left;"> 历史流程实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_TASKINST     </td>
<td style="text-align:left;"> 历史任务实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_VARINST      </td>
<td style="text-align:left;"> 历史变量表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_GROUP        </td>
<td style="text-align:left;"> 用户组信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_INFO         </td>
<td style="text-align:left;"> 用户扩展信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_MEMBERSHIP   </td>
<td style="text-align:left;"> 用户与用户组对应信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_USER         </td>
<td style="text-align:left;"> 用户信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_PROCDEF_INFO    </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_DEPLOYMENT   </td>
<td style="text-align:left;"> 部署信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_MODEL        </td>
<td style="text-align:left;"> 流程设计模型部署表 </td>
<td style="text-align:left;"> 流程设计器设计流程后，保存数据到该表 </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_PROCDEF      </td>
<td style="text-align:left;"> 流程定义数据表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_EVENT_SUBSCR </td>
<td style="text-align:left;"> throwEvent，catchEvent时间监听信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_EXECUTION    </td>
<td style="text-align:left;"> 运行时流程执行实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_IDENTITYLINK </td>
<td style="text-align:left;"> 运行时流程人员表，主要存储任务节点与参与者的相关信息 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_JOB          </td>
<td style="text-align:left;"> 运行时定时任务数据表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_TASK         </td>
<td style="text-align:left;"> 运行时任务节点表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_VARIABLE     </td>
<td style="text-align:left;"> 运行时流程变量数据表 </td>
<td style="text-align:left;"> </td>
</tr>
</tbody>
</table>


<p>参考：<a href="http://craft6.cn/detail/activiti_research_database.do">http://craft6.cn/detail/activiti_research_database.do</a>
<a href="http://blog.csdn.net/flygoa/article/details/51895228">http://blog.csdn.net/flygoa/article/details/51895228</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/28/ni-zhen-de-liao-jie-stringma/">你真的了解String吗</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-28T21:01:06+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>String是Java中最重要最常用的类，没有之一。但是我们很多人可能只知道String的存在和简单使用，并不了解其背后的实现以及为什么这么实现。
这里我就简单的挑选几个重要的节点讲解。</p>

<p>本文基于JDK 1.7</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xiaobaoqiu@xiaobaoqiu:~ java -version
</span><span class='line'>java version "1.7.0_80"
</span><span class='line'>Java(TM) SE Runtime Environment (build 1.7.0_80-b15)
</span><span class='line'>Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</span></code></pre></td></tr></table></div></figure>


<h1>实现</h1>

<p>Java其实就是char数组的一个包装,String真实的内容就是存储在char数组中，数组的一个特性就是在逻辑和存储上都是连续的、可随机访问的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/** The value is used for character storage. */
</span><span class='line'>private final char value[];</span></code></pre></td></tr></table></div></figure>


<p>String的操作其实都是围绕底层的char数组来的，比如trim实现，trim的其实是value的内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public String trim() {
</span><span class='line'>    int len = value.length;
</span><span class='line'>    int st = 0;
</span><span class='line'>    char[] val = value;    /* avoid getfield opcode */
</span><span class='line'>
</span><span class='line'>    while ((st &lt; len) && (val[st] &lt;= ' ')) {
</span><span class='line'>        st++;
</span><span class='line'>    }
</span><span class='line'>    while ((st &lt; len) && (val[len - 1] &lt;= ' ')) {
</span><span class='line'>        len--;
</span><span class='line'>    }
</span><span class='line'>    return ((st &gt; 0) || (len &lt; value.length)) ? substring(st, len) : this;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是，String中的很多实现都是使用 System.arraycopy 来实现数组数据的快速拷贝,System.arraycopy是一个native方法:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public char[] toCharArray() {
</span><span class='line'>    char result[] = new char[value.length];
</span><span class='line'>    System.arraycopy(value, 0, result, 0, value.length);
</span><span class='line'>    return result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>final &amp; immutable</h1>

<p>String基本约定中最重要的一条是Immutable，Immutable的意思就是对String的每次修改都是生成一个新的String，原始对象不受影响，类似于copy-on-write的思想。</p>

<p>先具体看一下什么是Immutable。String不可变很简单，如下图，给一个已有字符串"abcd"，第二次赋值成"abcedl"，不是在原内存地址上修改数据，而是重新指向一个新对象，新地址。</p>

<p><img src="/images/java/java_immutable.png"></p>

<p> 那String怎么做到不可变？主要通过三个手段
 (1).String类声明为final(不会被继承改掉这种Immutable特性)；
 (2).底层的value数组声明为final(value这个引用地址不可变)；
(3).所有String的方法里很小心的没有去动value数组里的元素，没有暴露内部成员字段；</p>

<p>其实String是不可变的关键都在底层的实现，而不是一个final修饰符。</p>

<p>不可变对象带来的最大好处就是线程安全，因为不会被改写。</p>

<h1>hashcode</h1>

<p>String内部属性除了value数组外，还有一个 hash，用于记录String的hash值。
String能这样讲hash值cache下来的原因就是上面提到的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/** Cache the hash code for the string */
</span><span class='line'>private int hash; // Default to 0</span></code></pre></td></tr></table></div></figure>


<p>每次调用hashCode，先检测 hash 是否已经计算好了，如果计算了，就不要重新计算。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int hashCode() {
</span><span class='line'>    int h = hash;
</span><span class='line'>    if (h == 0 && value.length &gt; 0) {
</span><span class='line'>        char val[] = value;
</span><span class='line'>
</span><span class='line'>        for (int i = 0; i &lt; value.length; i++) {
</span><span class='line'>            h = 31 * h + val[i];
</span><span class='line'>        }
</span><span class='line'>        hash = h;
</span><span class='line'>    }
</span><span class='line'>    return h;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>hash32</h1>

<p>String中有一个hash32()的方法，它的结果被缓存在成员变量int hash32 中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Cached value of the alternative hashing algorithm result
</span><span class='line'> */
</span><span class='line'>private transient int hash32 = 0;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Calculates a 32-bit hash value for this string.
</span><span class='line'> *
</span><span class='line'> * @return a 32-bit hash value for this string.
</span><span class='line'> */
</span><span class='line'>int hash32() {
</span><span class='line'>    int h = hash32;
</span><span class='line'>    if (0 == h) {
</span><span class='line'>       // harmless data race on hash32 here.
</span><span class='line'>       h = sun.misc.Hashing.murmur3_32(HASHING_SEED, value, 0, value.length);
</span><span class='line'>
</span><span class='line'>       // ensure result is not zero to avoid recalcing
</span><span class='line'>       h = (0 != h) ? h : 1;
</span><span class='line'>
</span><span class='line'>       hash32 = h;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return h;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>关于 hash32 为什么存在，可以看下面官网的说明：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Java SE 7u6 introduces an improved, alternative hash function for the following map and map-derived collection implementations:
</span><span class='line'>
</span><span class='line'>HashMap
</span><span class='line'>Hashtable
</span><span class='line'>HashSet
</span><span class='line'>LinkedHashMap
</span><span class='line'>LinkedHashSet
</span><span class='line'>WeakHashMap
</span><span class='line'>ConcurrentHashMap
</span><span class='line'>
</span><span class='line'>The alternative hash function improves the performance of these map implementations when a large number of key hash collisions are encountered.
</span><span class='line'>
</span><span class='line'>For Java SE 7u6, this alternative hash function is implemented as follows:
</span><span class='line'>
</span><span class='line'>The alternative hash function is only applied to maps with a capacity larger than a specified threshold size. By default, the threshold is -1. This value disables the alternative hash function. To enable the alternative hash function, set the jdk.map.althashing.threshold system property to a different value. The recommended value is 512. Setting this system property to 512 causes all maps with a capacity larger than 512 entries to use the alternative hash function. You can set this system property to 0, which causes all maps to use the alternative hash function.
</span><span class='line'>
</span><span class='line'>The following describes the jdk.map.althashing.threshold system property in more detail:
</span><span class='line'>
</span><span class='line'>Value type: Integer
</span><span class='line'>Value default: -1
</span><span class='line'>Value range: From -1 to 2147483647, inclusive
</span><span class='line'>Description: Threshold capacity at which maps use the alternative hash function. The value -1 is a synonym for 2147483647 (which is easier to remember). All other values correspond to threshold capacity.
</span><span class='line'>For example, the following command runs the Java application MyApplication and sets the jdk.map.althashing.threshold system property to 512:
</span><span class='line'>
</span><span class='line'>java -Djdk.map.althashing.threshold=512 MyApplication
</span><span class='line'>If the alternative hash function is being used, then the iteration order of keys, values, and entities vary for each instance of HashMap, Hashtable, HashSet, and ConcurrentHashMap. This change in iteration order may cause compatibility issues with some programs. This is the reason that the alternative hash function is disabled by default. Hashing improvements will be investigated in future releases. In the meantime, the system property jdk.map.althashing.threshold is experimental. It is strongly recommended that you test your applications with the alternative hashing function enabled (by setting jdk.map.althashing.threshold to 0) to determine if your applications are affected by iteration order. If there is an impact, you should fix your applications as soon as possible because there is no guarantee of iteration order.</span></code></pre></td></tr></table></div></figure>


<p>简单说就是为了解决 HashMap 这种hash 碰撞严重时候的性能，因为HashMap使用链地址法解决Hash碰撞，当链很长的时候，性能会受影响。
但是这个问题在Java 8 中已经解决了，因为Java 8中引入一个新的策略，当链比较长的时候(默认阈值10)，会转化为采用红黑树实现后面的链表，可以讲时间从O(N)降到O(lgN).</p>

<p>参考：
<a href="http://stackoverflow.com/questions/23716836/what-is-use-of-hash32-in-string-class">http://stackoverflow.com/questions/23716836/what-is-use-of-hash32-in-string-class</a>
<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/collections/changes7.html">http://docs.oracle.com/javase/7/docs/technotes/guides/collections/changes7.html</a>
<a href="http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object">http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object</a>
<a href="http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object/23926405#23926405">http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object/23926405#23926405</a></p>

<p>hash32这个方法最大的变化是，同一个字符串在不同的JVM上执行hash32()的结果可能不同（确切的说，多数情况下都会不同，因为其内部分别调用了一次System.currentTimeMillis()和两次System.nanoTime()用于初始化seed）。因此，某些容器在每次运行程序时迭代顺序都不同。</p>

<h1>CaseInsensitiveComparator</h1>

<p>在String中，有一个护额略大小写的比较方法，它的实现就是我们这里要说的CaseInsensitiveComparator</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int compareToIgnoreCase(String str) {
</span><span class='line'>    return CASE_INSENSITIVE_ORDER.compare(this, str);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public static final Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER = new CaseInsensitiveComparator();</span></code></pre></td></tr></table></div></figure>


<p>CaseInsensitiveComparator的实现如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static class CaseInsensitiveComparator implements Comparator&lt;String&gt;, java.io.Serializable {
</span><span class='line'>    // use serialVersionUID from JDK 1.2.2 for interoperability
</span><span class='line'>    private static final long serialVersionUID = 8575799808933029326L;
</span><span class='line'>
</span><span class='line'>    public int compare(String s1, String s2) {
</span><span class='line'>        int n1 = s1.length();
</span><span class='line'>        int n2 = s2.length();
</span><span class='line'>        int min = Math.min(n1, n2);
</span><span class='line'>        for (int i = 0; i &lt; min; i++) {
</span><span class='line'>            char c1 = s1.charAt(i);
</span><span class='line'>            char c2 = s2.charAt(i);
</span><span class='line'>            if (c1 != c2) {
</span><span class='line'>                c1 = Character.toUpperCase(c1);
</span><span class='line'>                c2 = Character.toUpperCase(c2);
</span><span class='line'>                if (c1 != c2) {
</span><span class='line'>                    c1 = Character.toLowerCase(c1);
</span><span class='line'>                    c2 = Character.toLowerCase(c2);
</span><span class='line'>                    if (c1 != c2) {
</span><span class='line'>                        // No overflow because of numeric promotion
</span><span class='line'>                        return c1 - c2;
</span><span class='line'>                    }
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return n1 - n2;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我们发现比较时候需要现将字符转化为大小比较，再转化为小写比较。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/20/cratewen-dang-fan-yi/">Crate文档翻译</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-20T12:37:02+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近准备开始抽个人时间着手翻译Crate的一些文档，主要是考虑两个方面：</p>

<pre><code>1.使用了1年的Crate，还没有比较全面的看Crate文档，很多特性肯定还不知道；
2.Crate被越来越多的人使用，中文文档肯定ui别人有帮助；
</code></pre>

<p>在 github 上开了个项目(其实很早就建工程了，一直没行动，也想通过这种方式驱动自己：先把牛B吹出去&hellip;)：</p>

<pre><code>https://github.com/xiaobaoqiu/crate_doc_cn.git
</code></pre>

<p>主要分三大块：</p>

<pre><code>1.Crate Server相关文档；
2.Crate Client相关文档；
3.Crate其他文档；
</code></pre>

<p>欢迎监督和参与。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <div class="panel-heading">
    <h1 class="panel-title">最新文章</h3>
  </div>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/29/activitishi-jian-chu-li/">Activiti事件处理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/29/activitiren-wu-zeng-jia-shu-xing/">Activiti任务增加属性</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/16/activitibiao/">Activiti表</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/28/ni-zhen-de-liao-jie-stringma/">你真的了解String吗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/20/cratewen-dang-fan-yi/">Crate文档翻译</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/22/%5B%3F%5D-ge-si-suo-wen-ti/">一个死锁问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/15/cong-dai-li-dao-springshi-wu-aop/">从代理到Spring事务2-AOP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/07/springshi-wu/">从代理到Spring事务3-Spring事务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/06/activitiru-men/">Activiti入门</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/11/cong-dai-li-dao-springshi-wu/">从代理到Spring事务1-代理</a>
      </li>
    
  </ul>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">文章分类</h1>
  </div>
  <div id="categories_list_div" class="list-group">
    <li><a class='list-group-item' href='/blog/categories/algorithm/'>algorithm (5)</a></li>
<li><a class='list-group-item' href='/blog/categories/druid/'>druid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/dubbo/'>dubbo (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/guava/'>guava (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/java/'>java (25)</a></li>
<li><a class='list-group-item' href='/blog/categories/library/'>library (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/linux/'>linux (13)</a></li>
<li><a class='list-group-item' href='/blog/categories/maven/'>maven (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/memcached/'>memcached (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/mybatis/'>mybatis (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/mysql/'>mysql (12)</a></li>
<li><a class='list-group-item' href='/blog/categories/octopress/'>octopress (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/postgresql/'>postgresql (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/protocol/'>protocol (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/qa/'>qa (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/reading/'>reading (7)</a></li>
<li><a class='list-group-item' href='/blog/categories/search/'>search (9)</a></li>
<li><a class='list-group-item' href='/blog/categories/spring/'>spring (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/squid/'>squid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/structure/'>structure (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tomcat/'>tomcat (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tools/'>tools (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/web/'>web (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/workflow/'>workflow (4)</a></li>
 
  </div>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">友情链接</h3>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://wenzhang.baidu.com/'>百度文章</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='https://github.com/xiaobaoqiu/leetcode'>LeetCode Solution</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://youdang.github.io/'>Youdang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://blog.csdn.net/ghsau'>Gaoshuang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://kriszhang.com/'>kriszhang's Blog</a>
  </div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - xiaobaoqiu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







<!--  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> -->





</body>
</html>
