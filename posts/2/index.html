
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>xiaobaoqiu Blog</title>
  <meta name="author" content="xiaobaoqiu">

  
  <meta name="description" content="1.任务增加属性 最近逐步将组内的审核业务迁移到 Activiti 上，为了适配已有业务，需要原生的 Activiti 的用户任务上增加一些属性，比如用户任务(UserTask)增加类型属性等。
Activiti版本为：5.22.0 1.任务增加属性 下面以增加任务类型为例子，记录修改点： 1 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xiaobaoqiu.github.io/posts/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link href="/atom.xml" rel="alternate" title="xiaobaoqiu Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

  

  
  <meta name="baidu-site-verification" content="5oIt2xaFFz" />
  <meta name="google-site-verification" content="U9Avd5Yqzpetvn_zxo1KaK2iqYNwSlLon27veprwBRY" />
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">xiaobaoqiu Blog</a></h1>
  
    <h2>Think More, Code Less</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="xiaobaoqiu@163.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="xiaobaoqiu.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有博文</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/29/activitiren-wu-zeng-jia-shu-xing/">Activiti任务增加属性</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-29T18:18:20+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="#1.%E4%BB%BB%E5%8A%A1%E5%A2%9E%E5%8A%A0%E5%B1%9E%E6%80%A7">1.任务增加属性</a></li>
</ul>


<p>最近逐步将组内的审核业务迁移到 Activiti 上，为了适配已有业务，需要原生的 Activiti 的用户任务上增加一些属性，比如用户任务(UserTask)增加类型属性等。
Activiti版本为：5.22.0</p>

<h2 id="1.任务增加属性">1.任务增加属性</h2>


<p>下面以增加任务类型为例子，记录修改点：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.修改表结构，ACT_RU_TASK表增加 TASK_TYPE_ 字段
</span><span class='line'>在 activiti-engine 包下，找自己对应的数据库的文件(mysql版本...)
</span><span class='line'>
</span><span class='line'>1.UserTask增加taskType属性
</span><span class='line'>包路径：org.activiti.bpmn.model.UserTask
</span><span class='line'>
</span><span class='line'>3.Task接口增加setTaskType方法
</span><span class='line'>包路径：org.activiti.engine.task.Task
</span><span class='line'>
</span><span class='line'>4.TaskEntity增加taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.persistence.entity.TaskEntity
</span><span class='line'>
</span><span class='line'>5.DelegateTask借口增加 getTaskType 和 setTaskType
</span><span class='line'>包路径：org.activiti.engine.delegate.DelegateTask
</span><span class='line'>
</span><span class='line'>6.TaskDefinition增加taskTypeExpression
</span><span class='line'>包路径：org.activiti.engine.impl.task.TaskDefinition
</span><span class='line'>
</span><span class='line'>7.DynamicBpmnConstants增加USER_TASK_TYPE
</span><span class='line'>包路径：org.activiti.engine.DynamicBpmnConstants
</span><span class='line'>
</span><span class='line'>8.UserTaskActivityBehavior设置taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior
</span><span class='line'>
</span><span class='line'>9.UserTaskParseHandler解析taskType属性
</span><span class='line'>包路径：org.activiti.engine.impl.bpmn.parser.handler.UserTaskParseHandler
</span><span class='line'>
</span><span class='line'>10.BpmnXMLConstants增加 ATTRIBUTE_TASK_USER_TYPE
</span><span class='line'>包路径：org.activiti.bpmn.constants.BpmnXMLConstants
</span><span class='line'>
</span><span class='line'>11.UserTaskXMLConverter注册 ATTRIBUTE_TASK_USER_TYPE
</span><span class='line'>包路径：org.activiti.bpmn.converter.UserTaskXMLConverter
</span><span class='line'>
</span><span class='line'>12. Semantic.xsd 文件
</span><span class='line'>包括各个版本的 XSD 文件(XML结构定义)
</span><span class='line'>
</span><span class='line'>13. HistoricTaskWrapper 增加 taskType
</span><span class='line'>包路径：org.activiti.explorer.ui.task.data.HistoricTaskWrapper
</span><span class='line'>
</span><span class='line'>14.HistoricTaskInstanceEntity 增加 taskType
</span><span class='line'>包路径：org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntity
</span><span class='line'>
</span><span class='line'>15. 更多...</span></code></pre></td></tr></table></div></figure>


<p>在自己的API中定义任务类型，然后我们可以修改 activiti-modeler 的相关代码，使得Activiti支持画图时候指定任务类型。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/16/activitibiao/">Activiti表</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-16T16:31:34+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>整理 Activiti 中的表含义，以及一些重要表的字段。本文的 Activiti 版本为 5.22.0</p>

<ul>
<li><a href="#1.%E8%A1%A8%E5%90%AB%E4%B9%89">1.表含义</a></li>
</ul>


<h2 id="1.表含义">1.表含义</h2>


<p>Activiti 中表定义 activiti-engine 这个 module 下，具体位置 /resources/org.activiti/db/create 下，包括各种类型数据库的建表语句，这里我们以Mysql为DB。</p>

<p>首先简单介绍表的前缀的含义，参考官网：<a href="http://www.activiti.org/userguide/index.html#database.tables.explained">http://www.activiti.org/userguide/index.html#database.tables.explained</a></p>

<p>表名称包含三个部分，第一个为所有的表共有的ACT_表示Activiti，第二部分表示表的使用场景</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>ACT_RE_*: RE表示repository，这个前缀的表包含了流程定义和流程静态资源
</span><span class='line'>ACT_RU_*: RU表示runtime，这些运行时的表，包含流程实例，任务，变量，异步任务等运行中的数据。Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。
</span><span class='line'>ACT_ID_*: ID表示identity，这些表包含身份信息，比如用户，组等。
</span><span class='line'>ACT_HI_*: HI表示history，这些表包含历史数据，比如历史流程实例， 变量，任务等。
</span><span class='line'>ACT_GE_*: 通用数据， 用于不同场景下。
</span><span class='line'>ACT_EVT_*: EVT表示EVENT，目前只有一张表ACT_EVT_LOG，存储事件处理日志，方便管理员跟踪处理。</span></code></pre></td></tr></table></div></figure>


<p>下面是各个表的大致意义：</p>

<table>
<thead>
<tr>
<th style="text-align:center;">表 </th>
<th style="text-align:left;"> 意义 </th>
<th style="text-align:left;"> 备注 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">ACT_EVT_LOG         </td>
<td style="text-align:left;"> 事件处理日志 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_GE_BYTEARRAY    </td>
<td style="text-align:left;"> 二进制数据表 </td>
<td style="text-align:left;"> 保存流程定义图片和xml </td>
</tr>
<tr>
<td style="text-align:center;">ACT_GE_PROPERTY     </td>
<td style="text-align:left;"> 属性数据表存储整个流程引擎级别的数据 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_ACTINST      </td>
<td style="text-align:left;"> 历史节点表 </td>
<td style="text-align:left;"> 只记录usertask内容 </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_ATTACHMENT   </td>
<td style="text-align:left;"> 历史附件表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_COMMENT      </td>
<td style="text-align:left;"> 历史意见表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_DETAIL       </td>
<td style="text-align:left;"> 历史详情表，提供历史变量的查询 </td>
<td style="text-align:left;"> 流程中产生的变量详细，包括控制流程流转的变量等</td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_IDENTITYLINK </td>
<td style="text-align:left;"> 历史流程人员表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_PROCINST     </td>
<td style="text-align:left;"> 历史流程实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_TASKINST     </td>
<td style="text-align:left;"> 历史任务实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_HI_VARINST      </td>
<td style="text-align:left;"> 历史变量表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_GROUP        </td>
<td style="text-align:left;"> 用户组信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_INFO         </td>
<td style="text-align:left;"> 用户扩展信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_MEMBERSHIP   </td>
<td style="text-align:left;"> 用户与用户组对应信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_ID_USER         </td>
<td style="text-align:left;"> 用户信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_PROCDEF_INFO    </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_DEPLOYMENT   </td>
<td style="text-align:left;"> 部署信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_MODEL        </td>
<td style="text-align:left;"> 流程设计模型部署表 </td>
<td style="text-align:left;"> 流程设计器设计流程后，保存数据到该表 </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RE_PROCDEF      </td>
<td style="text-align:left;"> 流程定义数据表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_EVENT_SUBSCR </td>
<td style="text-align:left;"> throwEvent，catchEvent时间监听信息表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_EXECUTION    </td>
<td style="text-align:left;"> 运行时流程执行实例表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_IDENTITYLINK </td>
<td style="text-align:left;"> 运行时流程人员表，主要存储任务节点与参与者的相关信息 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_JOB          </td>
<td style="text-align:left;"> 运行时定时任务数据表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_TASK         </td>
<td style="text-align:left;"> 运行时任务节点表 </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:center;">ACT_RU_VARIABLE     </td>
<td style="text-align:left;"> 运行时流程变量数据表 </td>
<td style="text-align:left;"> </td>
</tr>
</tbody>
</table>


<p>参考：<a href="http://craft6.cn/detail/activiti_research_database.do">http://craft6.cn/detail/activiti_research_database.do</a>
<a href="http://blog.csdn.net/flygoa/article/details/51895228">http://blog.csdn.net/flygoa/article/details/51895228</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/28/ni-zhen-de-liao-jie-stringma/">你真的了解String吗</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-28T21:01:06+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>String是Java中最重要最常用的类，没有之一。但是我们很多人可能只知道String的存在和简单使用，并不了解其背后的实现以及为什么这么实现。
这里我就简单的挑选几个重要的节点讲解。</p>

<p>本文基于JDK 1.7</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xiaobaoqiu@xiaobaoqiu:~ java -version
</span><span class='line'>java version "1.7.0_80"
</span><span class='line'>Java(TM) SE Runtime Environment (build 1.7.0_80-b15)
</span><span class='line'>Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</span></code></pre></td></tr></table></div></figure>


<h1>实现</h1>

<p>Java其实就是char数组的一个包装,String真实的内容就是存储在char数组中，数组的一个特性就是在逻辑和存储上都是连续的、可随机访问的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/** The value is used for character storage. */
</span><span class='line'>private final char value[];</span></code></pre></td></tr></table></div></figure>


<p>String的操作其实都是围绕底层的char数组来的，比如trim实现，trim的其实是value的内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public String trim() {
</span><span class='line'>    int len = value.length;
</span><span class='line'>    int st = 0;
</span><span class='line'>    char[] val = value;    /* avoid getfield opcode */
</span><span class='line'>
</span><span class='line'>    while ((st &lt; len) && (val[st] &lt;= ' ')) {
</span><span class='line'>        st++;
</span><span class='line'>    }
</span><span class='line'>    while ((st &lt; len) && (val[len - 1] &lt;= ' ')) {
</span><span class='line'>        len--;
</span><span class='line'>    }
</span><span class='line'>    return ((st &gt; 0) || (len &lt; value.length)) ? substring(st, len) : this;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是，String中的很多实现都是使用 System.arraycopy 来实现数组数据的快速拷贝,System.arraycopy是一个native方法:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public char[] toCharArray() {
</span><span class='line'>    char result[] = new char[value.length];
</span><span class='line'>    System.arraycopy(value, 0, result, 0, value.length);
</span><span class='line'>    return result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>final &amp; immutable</h1>

<p>String基本约定中最重要的一条是Immutable，Immutable的意思就是对String的每次修改都是生成一个新的String，原始对象不受影响，类似于copy-on-write的思想。</p>

<p>先具体看一下什么是Immutable。String不可变很简单，如下图，给一个已有字符串"abcd"，第二次赋值成"abcedl"，不是在原内存地址上修改数据，而是重新指向一个新对象，新地址。</p>

<p><img src="/images/java/java_immutable.png"></p>

<p> 那String怎么做到不可变？主要通过三个手段
 (1).String类声明为final(不会被继承改掉这种Immutable特性)；
 (2).底层的value数组声明为final(value这个引用地址不可变)；
(3).所有String的方法里很小心的没有去动value数组里的元素，没有暴露内部成员字段；</p>

<p>其实String是不可变的关键都在底层的实现，而不是一个final修饰符。</p>

<p>不可变对象带来的最大好处就是线程安全，因为不会被改写。</p>

<h1>hashcode</h1>

<p>String内部属性除了value数组外，还有一个 hash，用于记录String的hash值。
String能这样讲hash值cache下来的原因就是上面提到的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/** Cache the hash code for the string */
</span><span class='line'>private int hash; // Default to 0</span></code></pre></td></tr></table></div></figure>


<p>每次调用hashCode，先检测 hash 是否已经计算好了，如果计算了，就不要重新计算。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int hashCode() {
</span><span class='line'>    int h = hash;
</span><span class='line'>    if (h == 0 && value.length &gt; 0) {
</span><span class='line'>        char val[] = value;
</span><span class='line'>
</span><span class='line'>        for (int i = 0; i &lt; value.length; i++) {
</span><span class='line'>            h = 31 * h + val[i];
</span><span class='line'>        }
</span><span class='line'>        hash = h;
</span><span class='line'>    }
</span><span class='line'>    return h;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>hash32</h1>

<p>String中有一个hash32()的方法，它的结果被缓存在成员变量int hash32 中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Cached value of the alternative hashing algorithm result
</span><span class='line'> */
</span><span class='line'>private transient int hash32 = 0;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Calculates a 32-bit hash value for this string.
</span><span class='line'> *
</span><span class='line'> * @return a 32-bit hash value for this string.
</span><span class='line'> */
</span><span class='line'>int hash32() {
</span><span class='line'>    int h = hash32;
</span><span class='line'>    if (0 == h) {
</span><span class='line'>       // harmless data race on hash32 here.
</span><span class='line'>       h = sun.misc.Hashing.murmur3_32(HASHING_SEED, value, 0, value.length);
</span><span class='line'>
</span><span class='line'>       // ensure result is not zero to avoid recalcing
</span><span class='line'>       h = (0 != h) ? h : 1;
</span><span class='line'>
</span><span class='line'>       hash32 = h;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return h;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>关于 hash32 为什么存在，可以看下面官网的说明：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Java SE 7u6 introduces an improved, alternative hash function for the following map and map-derived collection implementations:
</span><span class='line'>
</span><span class='line'>HashMap
</span><span class='line'>Hashtable
</span><span class='line'>HashSet
</span><span class='line'>LinkedHashMap
</span><span class='line'>LinkedHashSet
</span><span class='line'>WeakHashMap
</span><span class='line'>ConcurrentHashMap
</span><span class='line'>
</span><span class='line'>The alternative hash function improves the performance of these map implementations when a large number of key hash collisions are encountered.
</span><span class='line'>
</span><span class='line'>For Java SE 7u6, this alternative hash function is implemented as follows:
</span><span class='line'>
</span><span class='line'>The alternative hash function is only applied to maps with a capacity larger than a specified threshold size. By default, the threshold is -1. This value disables the alternative hash function. To enable the alternative hash function, set the jdk.map.althashing.threshold system property to a different value. The recommended value is 512. Setting this system property to 512 causes all maps with a capacity larger than 512 entries to use the alternative hash function. You can set this system property to 0, which causes all maps to use the alternative hash function.
</span><span class='line'>
</span><span class='line'>The following describes the jdk.map.althashing.threshold system property in more detail:
</span><span class='line'>
</span><span class='line'>Value type: Integer
</span><span class='line'>Value default: -1
</span><span class='line'>Value range: From -1 to 2147483647, inclusive
</span><span class='line'>Description: Threshold capacity at which maps use the alternative hash function. The value -1 is a synonym for 2147483647 (which is easier to remember). All other values correspond to threshold capacity.
</span><span class='line'>For example, the following command runs the Java application MyApplication and sets the jdk.map.althashing.threshold system property to 512:
</span><span class='line'>
</span><span class='line'>java -Djdk.map.althashing.threshold=512 MyApplication
</span><span class='line'>If the alternative hash function is being used, then the iteration order of keys, values, and entities vary for each instance of HashMap, Hashtable, HashSet, and ConcurrentHashMap. This change in iteration order may cause compatibility issues with some programs. This is the reason that the alternative hash function is disabled by default. Hashing improvements will be investigated in future releases. In the meantime, the system property jdk.map.althashing.threshold is experimental. It is strongly recommended that you test your applications with the alternative hashing function enabled (by setting jdk.map.althashing.threshold to 0) to determine if your applications are affected by iteration order. If there is an impact, you should fix your applications as soon as possible because there is no guarantee of iteration order.</span></code></pre></td></tr></table></div></figure>


<p>简单说就是为了解决 HashMap 这种hash 碰撞严重时候的性能，因为HashMap使用链地址法解决Hash碰撞，当链很长的时候，性能会受影响。
但是这个问题在Java 8 中已经解决了，因为Java 8中引入一个新的策略，当链比较长的时候(默认阈值10)，会转化为采用红黑树实现后面的链表，可以讲时间从O(N)降到O(lgN).</p>

<p>参考：
<a href="http://stackoverflow.com/questions/23716836/what-is-use-of-hash32-in-string-class">http://stackoverflow.com/questions/23716836/what-is-use-of-hash32-in-string-class</a>
<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/collections/changes7.html">http://docs.oracle.com/javase/7/docs/technotes/guides/collections/changes7.html</a>
<a href="http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object">http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object</a>
<a href="http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object/23926405#23926405">http://stackoverflow.com/questions/23926312/difference-between-hash32-and-hash-in-java-string-object/23926405#23926405</a></p>

<p>hash32这个方法最大的变化是，同一个字符串在不同的JVM上执行hash32()的结果可能不同（确切的说，多数情况下都会不同，因为其内部分别调用了一次System.currentTimeMillis()和两次System.nanoTime()用于初始化seed）。因此，某些容器在每次运行程序时迭代顺序都不同。</p>

<h1>CaseInsensitiveComparator</h1>

<p>在String中，有一个护额略大小写的比较方法，它的实现就是我们这里要说的CaseInsensitiveComparator</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public int compareToIgnoreCase(String str) {
</span><span class='line'>    return CASE_INSENSITIVE_ORDER.compare(this, str);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>public static final Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER = new CaseInsensitiveComparator();</span></code></pre></td></tr></table></div></figure>


<p>CaseInsensitiveComparator的实现如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static class CaseInsensitiveComparator implements Comparator&lt;String&gt;, java.io.Serializable {
</span><span class='line'>    // use serialVersionUID from JDK 1.2.2 for interoperability
</span><span class='line'>    private static final long serialVersionUID = 8575799808933029326L;
</span><span class='line'>
</span><span class='line'>    public int compare(String s1, String s2) {
</span><span class='line'>        int n1 = s1.length();
</span><span class='line'>        int n2 = s2.length();
</span><span class='line'>        int min = Math.min(n1, n2);
</span><span class='line'>        for (int i = 0; i &lt; min; i++) {
</span><span class='line'>            char c1 = s1.charAt(i);
</span><span class='line'>            char c2 = s2.charAt(i);
</span><span class='line'>            if (c1 != c2) {
</span><span class='line'>                c1 = Character.toUpperCase(c1);
</span><span class='line'>                c2 = Character.toUpperCase(c2);
</span><span class='line'>                if (c1 != c2) {
</span><span class='line'>                    c1 = Character.toLowerCase(c1);
</span><span class='line'>                    c2 = Character.toLowerCase(c2);
</span><span class='line'>                    if (c1 != c2) {
</span><span class='line'>                        // No overflow because of numeric promotion
</span><span class='line'>                        return c1 - c2;
</span><span class='line'>                    }
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return n1 - n2;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我们发现比较时候需要现将字符转化为大小比较，再转化为小写比较。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/20/cratewen-dang-fan-yi/">Crate文档翻译</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-20T12:37:02+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近准备开始抽个人时间着手翻译Crate的一些文档，主要是考虑两个方面：</p>

<pre><code>1.使用了1年的Crate，还没有比较全面的看Crate文档，很多特性肯定还不知道；
2.Crate被越来越多的人使用，中文文档肯定ui别人有帮助；
</code></pre>

<p>在 github 上开了个项目(其实很早就建工程了，一直没行动，也想通过这种方式驱动自己：先把牛B吹出去&hellip;)：</p>

<pre><code>https://github.com/xiaobaoqiu/crate_doc_cn.git
</code></pre>

<p>主要分三大块：</p>

<pre><code>1.Crate Server相关文档；
2.Crate Client相关文档；
3.Crate其他文档；
</code></pre>

<p>欢迎监督和参与。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/22/%5B%3F%5D-ge-si-suo-wen-ti/">一个死锁问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-22T14:33:14+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>2:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="#1.%E8%83%8C%E6%99%AF">1.背景</a></li>
<li><a href="#2.%E9%97%AE%E9%A2%98%E9%87%8D%E7%8E%B0">2.问题重现</a></li>
<li><a href="#3.%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90">3.死锁分析</a>

<ul>
<li><a href="#3.1%20SQL%E5%8A%A0%E9%94%81">3.1 SQL加锁</a></li>
<li><a href="#3.2%20%E9%94%81%E5%86%B2%E7%AA%81">3.2 锁冲突</a></li>
</ul>
</li>
<li><a href="#4.%E8%A7%A3%E5%86%B3">4.解决</a></li>
<li><a href="#5.%E9%94%81%E7%AD%89%E5%BE%85">5.锁等待</a></li>
</ul>


<p>最近线上业务报了几次死锁问题，决定跟进。</p>

<h2 id="1.背景">1.背景</h2>


<p>有一个业务数据表business，维护了一个名为c_id的外键，一个c_id对应多个business数据。</p>

<p>在业务数据新增或者修改的时候，需要同步的维护 business 的数据，这时候正确的做法是diff新旧数据，得到需要删除的一部分数据，需要新增的一部分数据以及需要更新的一部分数据，这种实现有点麻烦(其实也不麻烦，使用Guava的集合操作)，因此工程师们的通常做法是先根据c_id删除现有数据，再插入新数据。这个时候很容易出现死锁。</p>

<p>这里也解释一下外键，在业务DB中，出于性能考虑，通常禁止使用外键，通常的做法是，外键这种关系的维护都体现在表中手动维护一个外键。</p>

<p>在交代一下数据库相关的背景：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DB：Mysql 5.6
</span><span class='line'>tx_isolation：REPEATABLE-READ</span></code></pre></td></tr></table></div></figure>


<h2 id="2.问题重现">2.问题重现</h2>


<p>我们在本地重现死锁信息。</p>

<p>建表语句已经初始化的数据如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE TABLE `business` (
</span><span class='line'>  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '',
</span><span class='line'>  `c_id` int(11) NOT NULL DEFAULT '0' COMMENT '',
</span><span class='line'>  `business_id` tinyint(3) unsigned NOT NULL DEFAULT '0' COMMENT '',
</span><span class='line'>  PRIMARY KEY (`id`),
</span><span class='line'>  UNIQUE KEY `uniq_idx_c_id_business_id` (`c_id`,`business_id`)
</span><span class='line'>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='';
</span><span class='line'>
</span><span class='line'>mysql&gt; select * from business;
</span><span class='line'>+----+-------------+-------------+
</span><span class='line'>| id | c_id | business_id |
</span><span class='line'>+----+-------------+-------------+
</span><span class='line'>| 20 |           1 |           2 |
</span><span class='line'>| 21 |           1 |           3 |
</span><span class='line'>| 23 |           1 |           4 |
</span><span class='line'>| 22 |           1 |           5 |
</span><span class='line'>| 10 |           2 |           1 |
</span><span class='line'>| 11 |           2 |           2 |
</span><span class='line'>|  5 |           3 |           1 |
</span><span class='line'>|  6 |           4 |           1 |
</span><span class='line'>|  7 |           5 |           1 |
</span><span class='line'>+----+-------------+-------------+</span></code></pre></td></tr></table></div></figure>


<p>我们模拟同时两个新数据的插入过程：</p>

<table>
<thead>
<tr>
<th style="text-align:center;">步骤 </th>
<th style="text-align:left;"> 事务1 </th>
<th style="text-align:left;"> 事务2 </th>
<th style="text-align:left;"> 备注 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">1 </td>
<td style="text-align:left;"> begin </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;">  </td>
</tr>
<tr>
<td style="text-align:center;">2 </td>
<td style="text-align:left;"> </td>
<td style="text-align:left;"> begin </td>
<td style="text-align:left;">  </td>
</tr>
<tr>
<td style="text-align:center;">3 </td>
<td style="text-align:left;"> mysql> delete from business where c_id = 6;<br><br>Query OK, 0 rows affected (0.00 sec) </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> 事务1：Gap锁，锁住区域(5, +∞) </td>
</tr>
<tr>
<td style="text-align:center;">4 </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> mysql> delete from business where c_id = 7;<br><br>Query OK, 0 rows affected (0.00 sec) </td>
<td style="text-align:left;"> 事务2：Gap锁，锁住区域(5, +∞)  </td>
</tr>
<tr>
<td style="text-align:center;">5 </td>
<td style="text-align:left;"> mysql> insert into business (c_id, business_id) values (6, 1);<br><br>等待&hellip; </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> 事务1：插入意向锁(Insert Intention Lock)，期望获取(5, 6)这个Gap锁和一个c_id=6的Recored锁。<br>但是因为 事务2 已经锁住了区域(5, +∞)因此这时候，事务1只能等待 事务2 释放锁. </td>
</tr>
<tr>
<td style="text-align:center;">6 </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> mysql> insert into business (c_id, business_id) values (7, 1); <br><br>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction </td>
<td style="text-align:left;"> 和上面第5步类似， 事务2：等待获取事务1的锁<br><br>出现循环等待，死锁(roll back这个事务，事务2的锁释放) </td>
</tr>
<tr>
<td style="text-align:center;">7 </td>
<td style="text-align:left;"> Query OK, 2 rows affected (2.89 sec)<br>Records: 2  Duplicates: 0  Warnings: 0<br><br>事务2 rollback了，事务1的insert成功 </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> 事务1等待的锁得到，事务1成功。</td>
</tr>
</tbody>
</table>


<p>第 5 步的锁信息如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 锁信息
</span><span class='line'>// 事务1( 即这里的事务id：203797) 持有一个Gap锁，事务2( 即这里的事务id：203798) 持有一个Gap锁
</span><span class='line'>mysql&gt; select * from INNODB_LOCKS;
</span><span class='line'>+---------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+------------------------+
</span><span class='line'>| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table                    | lock_index                       | lock_space | lock_page | lock_rec | lock_data              |
</span><span class='line'>+---------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+------------------------+
</span><span class='line'>| 203797:20:4:1 | 203797      | X         | RECORD    | `test`.`business` | uniq_idx_c_id_business_id |         20 |         4 |        1 | supremum pseudo-record |
</span><span class='line'>| 203798:20:4:1 | 203798      | X         | RECORD    | `test`.`business` | uniq_idx_c_id_business_id |         20 |         4 |        1 | supremum pseudo-record |
</span><span class='line'>+---------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+------------------------+
</span><span class='line'>
</span><span class='line'>// 锁等待信息
</span><span class='line'>// 事务1( 即这里的事务id：203797) 等待事务2(即这里的事务id：203798 )的锁
</span><span class='line'>mysql&gt; select * from INNODB_LOCK_WAITS;
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+
</span><span class='line'>| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+
</span><span class='line'>| 203797            | 203797:20:4:1     | 203798          | 203798:20:4:1    |
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+</span></code></pre></td></tr></table></div></figure>


<p>有些人可能迷惑 lock_data 的 supremum pseudo-record 是什么东西，我们先看看 lock_data 的解释，这里面解释了 supremum pseudo-record，简单说就是正无穷。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Primary key value(s) of the locked record if LOCK_TYPE='RECORD', otherwise NULL. 
</span><span class='line'>This column contains the value(s) of the primary key column(s) in the locked row, formatted as a valid SQL string (ready to be copied to SQL commands). 
</span><span class='line'>If there is no primary key then the InnoDB internal unique row ID number is used. 
</span><span class='line'>If a gap lock is taken for key values or ranges above the largest value in the index, LOCK_DATA reports “supremum pseudo-record”. 
</span><span class='line'>When the page containing the locked record is not in the buffer pool (in the case that it was paged out to disk while the lock was held), InnoDB does not fetch the page from disk, to avoid unnecessary disk operations. Instead, LOCK_DATA is set to NULL.</span></code></pre></td></tr></table></div></figure>


<p>死锁信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; show engine innodb status \G
</span><span class='line'>...
</span><span class='line'>------------------------
</span><span class='line'>LATEST DETECTED DEADLOCK
</span><span class='line'>------------------------
</span><span class='line'>2016-07-21 19:11:05 7f6b90de8700
</span><span class='line'>*** (1) TRANSACTION:
</span><span class='line'>TRANSACTION 203797, ACTIVE 42 sec inserting
</span><span class='line'>mysql tables in use 1, locked 1
</span><span class='line'>LOCK WAIT 3 lock struct(s), heap size 360, 2 row lock(s), undo log entries 1
</span><span class='line'>MySQL thread id 9, OS thread handle 0x7f6b90db7700, query id 144 localhost root update
</span><span class='line'>insert into business (c_id, business_id) values (6, 1)
</span><span class='line'>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
</span><span class='line'>RECORD LOCKS space id 20 page no 4 n bits 80 index `uniq_idx_c_id_business_id` of table `test`.`business` trx id 203797 lock_mode X insert intention waiting
</span><span class='line'>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span><span class='line'> 0: len 8; hex 73757072656d756d; asc supremum;;
</span><span class='line'>
</span><span class='line'>*** (2) TRANSACTION:
</span><span class='line'>TRANSACTION 203798, ACTIVE 38 sec inserting
</span><span class='line'>mysql tables in use 1, locked 1
</span><span class='line'>3 lock struct(s), heap size 360, 2 row lock(s), undo log entries 1
</span><span class='line'>MySQL thread id 10, OS thread handle 0x7f6b90de8700, query id 147 localhost root update
</span><span class='line'>insert into business (c_id, business_id) values (7, 1)
</span><span class='line'>*** (2) HOLDS THE LOCK(S):
</span><span class='line'>RECORD LOCKS space id 20 page no 4 n bits 80 index `uniq_idx_c_id_business_id` of table `test`.`business` trx id 203798 lock_mode X
</span><span class='line'>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span><span class='line'> 0: len 8; hex 73757072656d756d; asc supremum;;
</span><span class='line'>
</span><span class='line'>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
</span><span class='line'>RECORD LOCKS space id 20 page no 4 n bits 80 index `uniq_idx_c_id_business_id` of table `test`.`business` trx id 203798 lock_mode X insert intention waiting
</span><span class='line'>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
</span><span class='line'> 0: len 8; hex 73757072656d756d; asc supremum;;
</span><span class='line'>
</span><span class='line'>*** WE ROLL BACK TRANSACTION (2)
</span><span class='line'>------------
</span><span class='line'>TRANSACTIONS
</span><span class='line'>------------</span></code></pre></td></tr></table></div></figure>


<p>从死锁信息中，我们也可以看到事务1(事务id：203797) 和 事务2(事务id：203798) 持有的锁是锁住相同的一块区域：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 0: len 8; hex 73757072656d756d; asc supremum;;</span></code></pre></td></tr></table></div></figure>


<p>参考：<a href="http://blog.itpub.net/29819001/viewspace-1440895/">mysql InnoDB锁等待的查看及分析</a></p>

<h2 id="3.死锁分析">3.死锁分析</h2>


<p>有两个点需要我们知道的信息：各种SQL语句都加什么锁，为什么这里的两个delete的锁没有冲突。</p>

<h4 id="3.1 SQL加锁">3.1 SQL加锁</h4>


<p>关于各种SQL语句加什么锁，参见Mysql官方文档：<a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-locks-set.html">Locks Set by Different SQL Statements in InnoDB</a></p>

<p>我们这里来说涉及的删除和插入，先说删除：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//删除，会在满足条件的记录上加一个next-key锁，也就是锁住之前的Gap和待删除的记录。
</span><span class='line'>DELETE FROM ... WHERE ... sets an exclusive next-key lock on every record the search encounters.
</span><span class='line'>
</span><span class='line'>//显然，如果删除的数据比现有最大数据max还大，就会锁(max, +∞)这个Gap
</span><span class='line'>//同理，如果删除的数据比现有最小数据min还小，就会锁(-∞, min)这个Gap</span></code></pre></td></tr></table></div></figure>


<p>再说插入，插入比较麻烦，因为涉及到插入意向锁(Insert Intention Lock)，还是参考Mysql官方文档：<a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html">InnoDB Locking</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>An insert intention lock is a type of gap lock set by INSERT operations prior to row insertion. 
</span><span class='line'>This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. 
</span><span class='line'>Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.</span></code></pre></td></tr></table></div></figure>


<p>简单的是说，插入意向锁可以归结为如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>锁的类型：Gap Lock
</span><span class='line'>加锁时间：插入之前
</span><span class='line'>锁的区域：待插入的区域，比如已有数据4,7，想要插入5，就会锁住(4, 7)这个区域
</span><span class='line'>锁的冲突：只要两个插入的数据不在同一个位置(其实可以理解为同一个数据)，插入意向锁之间就不会冲突</span></code></pre></td></tr></table></div></figure>


<p>插入的锁如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INSERT sets an exclusive lock on the inserted row. This lock is an index-record lock, not a next-key lock (that is, there is no gap lock) and does not prevent other sessions from inserting into the gap before the inserted row.
</span><span class='line'>
</span><span class='line'>Prior to inserting the row, a type of gap lock called an insert intention gap lock is set. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. </span></code></pre></td></tr></table></div></figure>


<p>就是说插入之前会加一把插入意向锁，除此之外，会在插入的记录上加一把锁。</p>

<h4 id="3.2 锁冲突">3.2 锁冲突</h4>


<p>关于锁冲突，我们熟知的肯定是S和S兼容，X和其他所有都不兼容。事实上并没有这么简单。比如我们这里前面的例子，两个delete都加了X型的Gap锁，应该排斥才对，但事实上是兼容的。这里参考了<a href="http://narcissusoyf.iteye.com/blog/1637309">从一个死锁看mysql innodb的锁机制</a>这篇文章的结论(准备读源码验证)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>下面这个是 precise mode 的兼容矩阵：（这个兼容矩阵发生在X与X，S与X不兼容的情况下再进行比对的）
</span><span class='line'>
</span><span class='line'>    G    I     R    N (已经存在的锁,包括等待的锁)
</span><span class='line'>G   +     +    +     + 
</span><span class='line'>I    -      +    +     -
</span><span class='line'>R   +     +     -     -
</span><span class='line'>N   +     +     -     -
</span><span class='line'>
</span><span class='line'>+ 代表兼容， -代表不兼容. I代表插入意图锁,
</span><span class='line'>G代表Gap锁，I代表插入意图锁,R代表记录锁，N代表Next-Key锁.</span></code></pre></td></tr></table></div></figure>


<p>其实仔细读<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html">Mysql官方文档</a>，我们也能发现上面的两个delete的Gap锁是兼容的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Gap locks in InnoDB are “purely inhibitive”, which means they only stop other transactions from inserting to the gap. 
</span><span class='line'>They do not prevent different transactions from taking gap locks on the same gap. Thus, a gap X-lock has the same effect as a gap S-lock.</span></code></pre></td></tr></table></div></figure>


<p>意思就是说Gap锁的作用是只防止其他事务在这个Gap内的插入，而不排斥其他事务在同一个Gap加上Gap锁。因此Gap X锁和Gap S锁效果相同。
(真心文档每句话都需要仔细理解哈。)</p>

<h2 id="4.解决">4.解决</h2>


<p>DBA的建议：先根据 c_id 查询id，根据 id 删除;</p>

<p>其实只要保证数据存在再区删除就没问题，我们假设我们执行两个以存在数据的先删除再插入。</p>

<p>一个辅助的示意图如下：</p>

<p><img src="/images/mysql/lock.png"></p>

<h2 id="5.锁等待">5.锁等待</h2>


<p>其实上面的例子中会出现一个因为 UNIQUE KEY 导致的锁等待问题，我们可以重现，现有数据如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; select * from business;
</span><span class='line'>+----+-------------+-------------+
</span><span class='line'>| id | c_id | business_id |
</span><span class='line'>+----+-------------+-------------+
</span><span class='line'>| 20 |           1 |           2 |
</span><span class='line'>| 21 |           1 |           3 |
</span><span class='line'>| 23 |           1 |           4 |
</span><span class='line'>| 22 |           1 |           5 |
</span><span class='line'>| 10 |           2 |           1 |
</span><span class='line'>| 11 |           2 |           2 |
</span><span class='line'>|  5 |           3 |           1 |
</span><span class='line'>| 30 |           4 |           1 |
</span><span class='line'>|  7 |           5 |           1 |
</span><span class='line'>+----+-------------+-------------+</span></code></pre></td></tr></table></div></figure>


<p>过程如下：</p>

<table>
<thead>
<tr>
<th style="text-align:center;">步骤 </th>
<th style="text-align:left;"> 事务1 </th>
<th style="text-align:left;"> 事务2 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">1 </td>
<td style="text-align:left;"> begin </td>
<td style="text-align:left;">  |  </td>
</tr>
<tr>
<td style="text-align:center;">2 </td>
<td style="text-align:left;"> </td>
<td style="text-align:left;"> begin |  </td>
</tr>
<tr>
<td style="text-align:center;">3 </td>
<td style="text-align:left;"> mysql> delete from business where c_id = 3;<br><br>Query OK, 0 rows affected (0.00 sec) </td>
<td style="text-align:left;">  </td>
</tr>
<tr>
<td style="text-align:center;">4 </td>
<td style="text-align:left;">  </td>
<td style="text-align:left;"> mysql> delete from business where c_id = 4;<br><br>Query OK, 0 rows affected (0.00 sec) </td>
</tr>
<tr>
<td style="text-align:center;">5 </td>
<td style="text-align:left;"> mysql> insert into business (c_id, business_id) values (3, 1);<br><br>等待&hellip;</td>
<td style="text-align:left;">  </td>
</tr>
</tbody>
</table>


<p>INNODB_LOCKS信息及INNODB_LOCK_WAITS信息如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; select * from INNODB_LOCK_WAITS;
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+
</span><span class='line'>| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+
</span><span class='line'>| 204349            | 204349:20:4:12    | 204350          | 204350:20:4:12   |
</span><span class='line'>+-------------------+-------------------+-----------------+------------------+
</span><span class='line'>1 row in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt; select * from INNODB_LOCKS;
</span><span class='line'>+----------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+-----------+
</span><span class='line'>| lock_id        | lock_trx_id | lock_mode | lock_type | lock_table                    | lock_index                       | lock_space | lock_page | lock_rec | lock_data |
</span><span class='line'>+----------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+-----------+
</span><span class='line'>| 204349:20:4:12 | 204349      | S         | RECORD    | `test`.`business` | uniq_idx_c_id_business_id |         20 |         4 |       12 | 4, 1      |
</span><span class='line'>| 204350:20:4:12 | 204350      | X         | RECORD    | `test`.`business` | uniq_idx_c_id_business_id |         20 |         4 |       12 | 4, 1      |
</span><span class='line'>+----------------+-------------+-----------+-----------+-------------------------------+----------------------------------+------------+-----------+----------+-----------+</span></code></pre></td></tr></table></div></figure>


<p>show engine innodb status信息如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---TRANSACTION 204350, ACTIVE 24 sec
</span><span class='line'>4 lock struct(s), heap size 1184, 3 row lock(s), undo log entries 1
</span><span class='line'>MySQL thread id 22, OS thread handle 0x7fd7ee4f0700, query id 245 localhost root cleaning up
</span><span class='line'>---TRANSACTION 204349, ACTIVE 31 sec inserting
</span><span class='line'>mysql tables in use 1, locked 1
</span><span class='line'>LOCK WAIT 5 lock struct(s), heap size 1184, 4 row lock(s), undo log entries 2
</span><span class='line'>MySQL thread id 20, OS thread handle 0x7fd7ee4bf700, query id 250 localhost root update
</span><span class='line'>insert into business (c_id, business_id) values (3, 1)
</span><span class='line'>------- TRX HAS BEEN WAITING 6 SEC FOR THIS LOCK TO BE GRANTED:
</span><span class='line'>RECORD LOCKS space id 20 page no 4 n bits 80 index `uniq_idx_c_id_business_id` of table `test`.`business` trx id 204349 lock mode S waiting
</span><span class='line'>Record lock, heap no 12 PHYSICAL RECORD: n_fields 3; compact format; info bits 32
</span><span class='line'> 0: len 4; hex 80000004; asc     ;;
</span><span class='line'> 1: len 1; hex 01; asc  ;;
</span><span class='line'> 2: len 4; hex 0000001e; asc     ;;</span></code></pre></td></tr></table></div></figure>


<p>这里没明白的一点好事务1(事务id:204349)的insert一个(3, 1)的数据为什么会在(4, 1)上加一个S锁?</p>

<p>不过实验了一下，去掉UNIQUE KEY，使用普通的key，就没有这个锁等到问题，所以这个锁是因为UNIQUE KEY引发的。
这个问题有待进一步深入查资料。</p>

<p><a href="http://songuooo.com/2015/1/7/deadlock-detected-on-concurrent-insert">http://songuooo.com/2015/1/7/deadlock-detected-on-concurrent-insert</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <div class="panel-heading">
    <h1 class="panel-title">最新文章</h3>
  </div>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/02/04/api-blocking/">Api Blocking</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/03/shallowetagheaderfilter/">ShallowEtagHeaderFilter</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/03/activitizi-dong-liu-zhuan-ren-wu/">Activiti自动流转任务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/30/springshang-chuan-zu-jian-chong-tu/">Spring上传组件冲突</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/29/activitishi-jian-chu-li/">Activiti事件处理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/29/activitiren-wu-zeng-jia-shu-xing/">Activiti任务增加属性</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/16/activitibiao/">Activiti表</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/28/ni-zhen-de-liao-jie-stringma/">你真的了解String吗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/20/cratewen-dang-fan-yi/">Crate文档翻译</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/22/%5B%3F%5D-ge-si-suo-wen-ti/">一个死锁问题</a>
      </li>
    
  </ul>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">文章分类</h1>
  </div>
  <div id="categories_list_div" class="list-group">
    <li><a class='list-group-item' href='/blog/categories/algorithm/'>algorithm (5)</a></li>
<li><a class='list-group-item' href='/blog/categories/druid/'>druid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/dubbo/'>dubbo (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/guava/'>guava (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/java/'>java (25)</a></li>
<li><a class='list-group-item' href='/blog/categories/library/'>library (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/linux/'>linux (13)</a></li>
<li><a class='list-group-item' href='/blog/categories/maven/'>maven (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/memcached/'>memcached (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/mybatis/'>mybatis (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/mysql/'>mysql (12)</a></li>
<li><a class='list-group-item' href='/blog/categories/octopress/'>octopress (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/postgresql/'>postgresql (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/protocol/'>protocol (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/qa/'>qa (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/reading/'>reading (7)</a></li>
<li><a class='list-group-item' href='/blog/categories/search/'>search (9)</a></li>
<li><a class='list-group-item' href='/blog/categories/spring/'>spring (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/squid/'>squid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/structure/'>structure (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/system/'>system (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/tomcat/'>tomcat (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tools/'>tools (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/web/'>web (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/workflow/'>workflow (5)</a></li>
 
  </div>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">友情链接</h3>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://wenzhang.baidu.com/'>百度文章</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='https://github.com/xiaobaoqiu/leetcode'>LeetCode Solution</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://youdang.github.io/'>Youdang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://blog.csdn.net/ghsau'>Gaoshuang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://kriszhang.com/'>kriszhang's Blog</a>
  </div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - xiaobaoqiu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







<!--  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> -->





</body>
</html>
