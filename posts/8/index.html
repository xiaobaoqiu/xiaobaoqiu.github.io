
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>xiaobaoqiu Blog</title>
  <meta name="author" content="xiaobaoqiu">

  
  <meta name="description" content="历经一个月的项目,使用Crate提升搜索速度终于要上线.先交代一下背景,我们使用的crate相关的依赖的版本: 1.crate-client 0.47.8
2.crate-jdbc 1.5.1 发布之后,验证阶段一切正常,等把流量入口打开,一段时间之后, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xiaobaoqiu.github.io/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link href="/atom.xml" rel="alternate" title="xiaobaoqiu Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

  
  <meta name="baidu-site-verification" content="5oIt2xaFFz" />
  <meta name="google-site-verification" content="U9Avd5Yqzpetvn_zxo1KaK2iqYNwSlLon27veprwBRY" />
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">xiaobaoqiu Blog</a></h1>
  
    <h2>Think More, Code Less</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="xiaobaoqiu@163.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="xiaobaoqiu.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有博文</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/20/crate-jdbccha-xun-si-xun-huan-bug/">Crate Jdbc查询死循环bug</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-20T05:41:17+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>历经一个月的项目,使用Crate提升搜索速度终于要上线.先交代一下背景,我们使用的crate相关的依赖的版本:</p>

<pre><code>1.crate-client  0.47.8
2.crate-jdbc    1.5.1
</code></pre>

<p>发布之后,验证阶段一切正常,等把流量入口打开,一段时间之后,猛然发现crate的一个查询服务所在的机器load飙到20往上,机器是4核CPU,4G内存的虚拟机.</p>

<p>top -H发现有大量的tomcat线程(10+),每个线程占用的CPU都达到20%,并且这种线程有增多的趋势.</p>

<p>vmstat命令发现r数字特别高,即正在等待CPU的线程非常多.</p>

<p>jstack的结果发现runnable的线程多达300多.</p>

<p>看现象,感觉问题是线程池分配没有回收,但是定位不到问题在哪.</p>

<p>最终定位的问题是在特定场景下存在死循环,并且直接才crate服务器执行相同的查询逻辑正常返回,因此基本定位在crate-jdbc中.</p>

<h1>1.死循环场景</h1>

<pre><code>1.crate中数据为空,这是很从crate中查询数据;
2.crate中存在满足查询条件数据,我们分页查询,假设总数据量为10页,我们因为代码问题,直接查询第11页的内容(实际上肯定不存在);
</code></pre>

<h1>2.原因</h1>

<p>原因是这个版本crate-jdbc和mybatis一起存在死循环,如下,我们对crate的查询首先经过mybatis,从</p>

<pre><code>1.MapperProxy.invoke
2.MapperMethod.execute
3.SqlSessionTemplate.selectList, SqlSessionTemplate.invoke
4.DefaultSqlSession.selectList
5.BaseExecutor.query, BaseExecutor.queryFromDatabase
6.ReuseExecutor.doQuery
7.RoutingStatementHandler.query
8.PreparedStatementHandler.query
9.CratePreparedStatement.execute()
10.DefaultResultSetHandler.handleResultSets, DefaultResultSetHandler.getFirstResultSet
</code></pre>

<p>问题的代码就在DefaultResultSetHandler.getFirstResultSet中:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private ResultSetWrapper getFirstResultSet(Statement stmt) throws SQLException {
</span><span class='line'>    ResultSet rs = stmt.getResultSet();
</span><span class='line'>    while (rs == null) {
</span><span class='line'>        // move forward to get the first resultset in case the driver
</span><span class='line'>        // doesn't return the resultset as the first result (HSQLDB 2.1)
</span><span class='line'>        if (stmt.getMoreResults()) {
</span><span class='line'>            rs = stmt.getResultSet();
</span><span class='line'>        } else {
</span><span class='line'>            if (stmt.getUpdateCount() == -1) {
</span><span class='line'>                // no more results. Must be no resultset
</span><span class='line'>                break;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return rs != null ? new ResultSetWrapper(rs, configuration) : null;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>其中stmt为CratePreparedStatement,其getMoreResults()实现:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Override
</span><span class='line'>public boolean getMoreResults() throws SQLException {
</span><span class='line'>    return false;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>因此逻辑进入到else中,stmt.getUpdateCount()的实现:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Override
</span><span class='line'>public int getUpdateCount() throws SQLException {
</span><span class='line'>    checkClosed();  //check connection是否被关闭
</span><span class='line'>    if (resultSet == null && sqlResponse != null) {
</span><span class='line'>        return (int) sqlResponse.rowCount();
</span><span class='line'>    }
</span><span class='line'>    return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>其中CratePreparedStatement的resultSet为null,并且sqlResponse不为空,sqlResponse的rowCount为0,因此getUpdateCount()返回值为0.因此getFirstResultSet中继续在while循环中,无法跳出.</p>

<p><img src="/images/crate/crate_jdbc_bug_code.png"></p>

<h1>3.绕过</h1>

<p>归结起来产生问题的很简单,就是查询的结果集为空的时候,就会产生死循环,针对两种死循环场景,我们都可以绕过:</p>

<pre><code>1.查询之前,先执行count查询,当count为0,即crate中没有满足我们查询条件的数据,则直接返回空数据集;
2.分页查询的时候,先执行count查询,当分页的offset大于等于count,则值额节返回空数据集;
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/19/mysql-thread-pool-size/">Mysql Thread_pool_size</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-19T06:23:18+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近项目中的beta环境,多个应用(10+个)连接数据库,使用的是连接池管理数据库连接.</p>

<p>最近应用中经常抛出数据库连接异常(我们使用的连接池是druid),简单的就是说无法获取Mysql的连接,创建连接失败(create connection error):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2015-05-14 15:50:51 ERROR com.alibaba.druid.pool.DruidDataSource:1363] create connection error 
</span><span class='line'>com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</span><span class='line'>
</span><span class='line'>The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
</span><span class='line'>    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) ~[na:1.7.0_45]
</span><span class='line'>    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57) ~[na:1.7.0_45]
</span><span class='line'>    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) ~[na:1.7.0_45]
</span><span class='line'>    at java.lang.reflect.Constructor.newInstance(Constructor.java:526) ~[na:1.7.0_45]
</span><span class='line'>    at com.mysql.jdbc.Util.handleNewInstance(Util.java:411) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:1117) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:350) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2393) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2430) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2215) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:813) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:47) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at sun.reflect.GeneratedConstructorAccessor34.newInstance(Unknown Source) ~[na:na]
</span><span class='line'>    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) ~[na:1.7.0_45]
</span><span class='line'>    at java.lang.reflect.Constructor.newInstance(Constructor.java:526) ~[na:1.7.0_45]
</span><span class='line'>    at com.mysql.jdbc.Util.handleNewInstance(Util.java:411) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:334) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>    at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1296) ~[druid-0.2.18.jar:0.2.18]
</span><span class='line'>    at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1352) ~[druid-0.2.18.jar:0.2.18]
</span><span class='line'>    at com.alibaba.druid.pool.DruidDataSource$CreateConnectionThread.run(DruidDataSource.java:1361) ~[druid-0.2.18.jar:0.2.18]
</span><span class='line'>Caused by: java.net.ConnectException: Connection refused
</span><span class='line'>        at java.net.PlainSocketImpl.socketConnect(Native Method) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:339) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.Socket.connect(Socket.java:579) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.Socket.connect(Socket.java:528) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.Socket.&lt;init&gt;(Socket.java:425) ~[na:1.7.0_45]
</span><span class='line'>        at java.net.Socket.&lt;init&gt;(Socket.java:241) ~[na:1.7.0_45]
</span><span class='line'>        at com.mysql.jdbc.StandardSocketFactory.connect(StandardSocketFactory.java:257) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>        at com.mysql.jdbc.MysqlIO.&lt;init&gt;(MysqlIO.java:300) ~[mysql-connector-java-5.1.21.jar:na]
</span><span class='line'>        ... 14 common frames omitted</span></code></pre></td></tr></table></div></figure>


<p>开始怀疑机器的压力过大,将一些应用停止,还是出现这个问题.</p>

<p>但是相同的代码在dev环境一切正常,beta环境的机器配置要优于dev环境的.</p>

<h1>1.Druid配置</h1>

<p>首先怀疑那块的代码问题导致的Mysql连接没有被释放.</p>

<p>由于我们使用Druid连接池,尝试使用Druid的removeAbandoned功能,这个配置的意义就是连接泄漏监测,通过这个监控没有发现异常.</p>

<p>当程序存在缺陷时，申请的连接忘记关闭，这时候，就存在连接泄漏了。Druid提供了RemoveAbandanded相关配置，用来关闭长时间不使用的连接.</p>

<p>配置removeAbandoned对性能会有一些影响，建议怀疑存在泄漏之后再打开。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;property name="removeAbandoned" value="true" /&gt; &lt;!-- 打开removeAbandoned功能--&gt;
</span><span class='line'>&lt;property name="removeAbandonedTimeout" value="600" /&gt; &lt;!-- 600秒，也就是10分钟--&gt;
</span><span class='line'>&lt;property name="logAbandoned" value="true" /&gt; &lt;!-- 关闭abanded连接时输出错误日志--&gt;</span></code></pre></td></tr></table></div></figure>


<p>`
当removeAbandoned=true之后，可以在内置监控界面datasource.html中的查看ActiveConnection StackTrace属性的，可以看到未关闭连接的具体堆栈信息，从而方便查出哪些连接泄漏了。</p>

<p>参考:
<a href="https://github.com/alibaba/druid/wiki/%E8%BF%9E%E6%8E%A5%E6%B3%84%E6%BC%8F%E7%9B%91%E6%B5%8B">https://github.com/alibaba/druid/wiki/%E8%BF%9E%E6%8E%A5%E6%B3%84%E6%BC%8F%E7%9B%91%E6%B5%8B</a></p>

<h1>2.diff mysql status</h1>

<p>既然dev环境正常,因此我们的做法是拿出dev环境和beta环境的show status结果进行diff,结果发现了一个比较可疑的参数的配置有差异:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>thread_pool_size</span></code></pre></td></tr></table></div></figure>


<p>dev环境配置是16,而beta环境是4,同时线上环境的配置是24.初步判断beta环境的thread_pool_size设置应该是有问题的.</p>

<h1>3.thread_pool_size</h1>

<p>参考官网的描述</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>thread_pool_size is the most important parameter controlling thread pool performance. It can be set only at server startup. Our experience in testing the thread pool indicates the following:
</span><span class='line'>
</span><span class='line'>If the primary storage engine is InnoDB, the optimal thread_pool_size setting is likely to be between 16 and 36, with the most common optimal values tending to be from 24 to 36. We have not seen any situation where the setting has been optimal beyond 36. There may be special cases where a value smaller than 16 is optimal.
</span><span class='line'>
</span><span class='line'>For workloads such as DBT2 and Sysbench, the optimum for InnoDB seems to be usually around 36. For very write-intensive workloads, the optimal setting can sometimes be lower.
</span><span class='line'>
</span><span class='line'>If the primary storage engine is MyISAM, the thread_pool_size setting should be fairly low. We tend to get optimal performance for values from 4 to 8. Higher values tend to have a slightly negative but not dramatic impact on performance.</span></code></pre></td></tr></table></div></figure>


<p>简单的翻译一下:
thread_pool_size是控制线程池性能最重要的一个参数,这个参数只能在Mysql服务启动的时候设置(这是官网5.5版本的文档,5.6版本证明是可以动态修改的).官网的推荐设置:</p>

<pre><code>1.如果存储引擎是InnoDB,thread_pool_size值设置16到36之间比较好,一般配置在24到36之间;
2.如果存储引擎是MyISAM,thread_pool_size值应该被设置得相当小,倾向于设置在4到8之间;
</code></pre>

<p>官方网站:
<a href="https://dev.mysql.com/doc/refman/5.5/en/thread-pool-tuning.html">https://dev.mysql.com/doc/refman/5.5/en/thread-pool-tuning.html</a></p>

<h3>3.1 thread_pool_size意义</h3>

<p>参数thread_pool_size的命令可能会让大家产生误解，它不是指的线程池的大小，而是线程组的大小。</p>

<p>类似所有创建的线程都在某一个group里，group的编号从1~thread_pool_size，每个group里的worker线程数可以通过参数thread_pool_oversubscribe来控制（默认为3）.</p>

<p>同时活跃的最大worker线程数=thread_pool_size * (thread_pool_oversubscribe + 1);</p>

<p>thread_pool_size默认值为CPU核心数，最大为128(MAX_THREAD_GROUPS)，在启动时，就会把128个Group对应的结构体(all_groups)初始化好。每个group(编号小于等于thread_pool_size)会创建一个epoll对象；</p>

<p>当MySQL建立connection时, MySQL根据connection的thread id对thread_pool_size取模,将 connection发起的sql语句分配到对应的group.若worker达到最大数量后还是不足以处理回话请求, 则连接在本group上等待,导致sql语句的RT(Response time)增大。</p>

<p>简单示意图如下:</p>

<p><img src="/images/mysql/Mysql_Pool.png"></p>

<p>所有之前的问题出现的情况是:</p>

<pre><code>1.thread_pool_size为4,即mysql每个thread pool的group中work线程的大小为4,如果有多个应用,恰好多个线程的connection被分发到某一个group上(假设为group-2),并且相当长一段时间一致在占有(比如我们在beta环境的连接,会占用并忙碌长达半小时),这时候,新来的连接正好也分发到group-2上,这时候Mysql上的group-2就没有多余的work线程来为其服务,即其无法和mysql创建连接,从而出现create connection error的异常.
</code></pre>

<p>参考:
<a href="http://get.jobdeer.com/908.get">http://get.jobdeer.com/908.get</a>
<a href="http://chuansong.me/n/1192563">http://chuansong.me/n/1192563</a>
<a href="http://mysqllover.com/?p=826">http://mysqllover.com/?p=826</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/18/spring-aopwu-xiao/">Spring AOP无效</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-18T19:31:35+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近在重构项目,有一个场景:根据方法的返回值判断是否成功,成功则从入参里获取需要的参数,构造消息(Msg)并发送通知其他模块.</p>

<p>因为是比较通用的逻辑(判断返回值,获取参数,发送消息),因此做成Spring注解的形式,注解中会用AOP拦截方法获取方法的返回值和参数.</p>

<p>其中获取参数使用的是Spring SpEL表达式.</p>

<h1>1.使用背景</h1>

<p>碰到的一个问题是AOP拦截无法获取private,protected和inner方法的参数.使用场景如下:</p>

<h3>1.1 注解定义</h3>

<p>首先定义注解用于获取</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Target(ElementType.METHOD)
</span><span class='line'>@Retention(RetentionPolicy.RUNTIME)
</span><span class='line'>public @interface Param {
</span><span class='line'>    /**
</span><span class='line'>     * 参数定义,标识了参数的获取方式,或常量值
</span><span class='line'>     */
</span><span class='line'>    String[] params();
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 操作类型,标识了当前这注解该被哪个处理类来处理
</span><span class='line'>     */
</span><span class='line'>    String[] operate();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>1.2 定义切面</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Aspect
</span><span class='line'>public class testAspect {
</span><span class='line'>    /**
</span><span class='line'>     * 根据注解获取切面
</span><span class='line'>     */
</span><span class='line'>    @Pointcut("@annotation(com.aaa.bbb.ccc.ParamGrabber)")
</span><span class='line'>    public void aspectPointCut() {
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>    * AOP, 定义方法返回之后的操作
</span><span class='line'>    */
</span><span class='line'>    @AfterReturning(value = "aspectPointCut()", returning = "returnValue")
</span><span class='line'>    public void afterReturning(JoinPoint point, Object returnValue){
</span><span class='line'>        //1.获取拦截的类和方法
</span><span class='line'>
</span><span class='line'>        //2.获取方法上我们定义的特定注解
</span><span class='line'>
</span><span class='line'>        //3.根据注解的参数中的spel表达式,从方法入参中获取我们需要的参数
</span><span class='line'>
</span><span class='line'>        //4.一些列的Processor处理逻辑
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>1.3 处理类</h3>

<p>定义获取的参数之后的处理类的逻辑:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public interface Processor {
</span><span class='line'>    /**
</span><span class='line'>     * 本processor可以处理的操作类型
</span><span class='line'>     */
</span><span class='line'>    List&lt;String&gt; supportOperates();
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     *
</span><span class='line'>     * 此processor的处理逻辑
</span><span class='line'>     */
</span><span class='line'>    void process(XxxContext context);
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * 返回值验证,是否需要执行process操作
</span><span class='line'>     */
</span><span class='line'>    boolean isReturnValid(XxxContext context, Object returnValue);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>之后利用Spring就可以获取上下问中所有的实现类:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class ProcessorSupport implements ApplicationContextAware, InitializingBean {
</span><span class='line'>    // Spring上下文
</span><span class='line'>    private ApplicationContext applicationContext;
</span><span class='line'>
</span><span class='line'>    private final Multimap&lt;String, Processor&gt; processorMap = HashMultimap.create();
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
</span><span class='line'>        this.applicationContext = applicationContext;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void afterPropertiesSet() throws Exception {
</span><span class='line'>        // 从Spring上下文获取Processor的所有具体实现类
</span><span class='line'>        Map&lt;String, Processor&gt; beansOfType = applicationContext.getBeansOfType(Processor.class);
</span><span class='line'>        for(Processor processor : beansOfType.values()) {
</span><span class='line'>            for(String op : processor.supportOperates()) {
</span><span class='line'>                processorMap.put(op, processor);
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    //根据注解中定义的operate来获取具体的处理类Processor
</span><span class='line'>    @Override
</span><span class='line'>    public Collection&lt;Processor&gt; getProcessor(String operate) {
</span><span class='line'>        return processorMap.get(operate);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>1.4 使用</h3>

<p>使用的时候,首先得实现一个具体的Processor:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class MyProcessor implements Processor {
</span><span class='line'>
</span><span class='line'>    public static final String SPECIFIC_PROCESSOR_KEY = "SPECIFIC_PROCESSOR_KEY";
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public List&lt;String&gt; supportOperates() {
</span><span class='line'>        return ImmutableList.of(
</span><span class='line'>                SPECIFIC_PROCESSOR_KEY
</span><span class='line'>        );
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void process(XxxContext context) {
</span><span class='line'>        //获取注解解析得到的参数
</span><span class='line'>        Map&lt;String, Object&gt; parsedParam = context.getParsedParam();
</span><span class='line'>
</span><span class='line'>        //构建发送的消息内容
</span><span class='line'>        Msg msg = buildNoticeMsg(parsedParam);
</span><span class='line'>
</span><span class='line'>        //发送消息
</span><span class='line'>        noticeService.doNotice(msg);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public boolean isReturnValid(XxxContext context, Object returnValue) {
</span><span class='line'>        //判断返回值是否有效...
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>具体使用的地方:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'>* 根据SPECIFIC_PROCESSOR_KEY找到MyProcessor
</span><span class='line'>* params中使用SpEL获取参数中的某个属性
</span><span class='line'>*/
</span><span class='line'>@Param(operate = MyProcessor.SPECIFIC_PROCESSOR_KEY, params = {
</span><span class='line'>        CrateConstants.KEYS_KEY + "={#p0.![propertyName]}"})
</span><span class='line'>public int batchInsert(List&lt;Tag&gt; tagList) {
</span><span class='line'>    if (CollectionUtils.isEmpty(tagList)) {
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return tagDao.insertBatchly(tagList);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>2.问题</h1>

<h3>2.1 private和protected方法无效</h3>

<p>private和protected方法(通常为类的inner方法)无法使用我们定义的注解来达到目的,如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//供外部调用的方法
</span><span class='line'>public class XxxService {
</span><span class='line'>    public int outerMethod(List&lt;Tag&gt; tagList) {
</span><span class='line'>        return innerMethod(tagList);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//被当前类的其他方法调用的内部方法
</span><span class='line'>@Param(operate = MyProcessor.SPECIFIC_PROCESSOR_KEY, params = {
</span><span class='line'>        CrateConstants.KEYS_KEY + "={#p0.![propertyName]}"})
</span><span class='line'>private int innerMethod(List&lt;Tag&gt; tagList) {
</span><span class='line'>    if (CollectionUtils.isEmpty(tagList)) {
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return tagDao.insertBatchly(tagList);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>2.2 inner public方法无效</h3>

<p>定义如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//供外部调用的方法
</span><span class='line'>public class XxxService {
</span><span class='line'>    public int outerMethod(List&lt;Tag&gt; tagList) {
</span><span class='line'>        return innerMethod(tagList);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//被当前类的其他方法调用的内部方法
</span><span class='line'>@Param(operate = MyProcessor.SPECIFIC_PROCESSOR_KEY, params = {
</span><span class='line'>        CrateConstants.KEYS_KEY + "={#p0.![propertyName]}"})
</span><span class='line'>public int innerMethod(List&lt;Tag&gt; tagList) {
</span><span class='line'>    if (CollectionUtils.isEmpty(tagList)) {
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return tagDao.insertBatchly(tagList);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>调用的时候调用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xxxServiceIns.outerMethod(...);</span></code></pre></td></tr></table></div></figure>


<h1>3.原因</h1>

<h3>3.1 private和protected方法无效</h3>

<p>Spring的AOP框架基于代理实现的(proxy-based).使用原生的Java的代理是无法代理protected和private类型的方法(详见后续结束).</p>

<p>而CGLIB的代理虽然在技术上可以代理protected和private类型的方法,但是用于AOP的时候不推荐代理protected和private类型的方法.</p>

<p>结论就是,任何定义的pointcut只在public方法上有效.</p>

<p>参考:</p>

<p><a href="http://stackoverflow.com/questions/15093894/aspectj-pointcut-for-annotated-private-methods">http://stackoverflow.com/questions/15093894/aspectj-pointcut-for-annotated-private-methods</a></p>

<p>spring官方文档关于AOP的解释中也有相关的说明:</p>

<p><a href="http://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-introduction-spring-defn">http://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-introduction-spring-defn</a></p>

<h3>3.2 inner public方法无效</h3>

<p>原因其实就是一句话:Spring AOP是基于代理机制的.</p>

<p>考虑如下场景,当你拿到一个无代理的、无任何特殊之处的对象引用时:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class SimplePojo implements SimpleInterface {
</span><span class='line'>    public void foo() {
</span><span class='line'>       // this next method invocation is a direct call on the 'this' reference
</span><span class='line'>       this.bar();
</span><span class='line'>    }
</span><span class='line'>                
</span><span class='line'>    public void bar() {
</span><span class='line'>        // some logic...
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>当你调用一个对象引用的方法时,此对象引用上的方法直接被调用,如下所示:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public static void main(String[] args) {
</span><span class='line'>   SimplePojo ins = new SimplePojo();
</span><span class='line'>   // this is a direct method call on the 'ins' reference
</span><span class='line'>   ins.foo();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/sping/call_native.png"></p>

<p>当客户代码所持有的引用是一个代理的时候则略有不同了,当调用foo()方法时候,首先会调用原始foo()方法上的@Before的代码逻辑,然后调用原始的foo()方法,原始foo()方法内的bar()调用的是原始对象的this.bar(),即一旦调用最终抵达了目标对象 (此处为SimplePojo类的引用),任何对自身的调用例如this.bar()将对this引用进行调用而非代理。</p>

<p>这一点意义重大,它意味着自我调用将不会导致和方法调用关联的AOP通知得到执行的机会。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SimplePojo proxy = proxyFactory.getProxy(Pojo.class);
</span><span class='line'>proxy.foo();</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/sping/call_proxy.png"></p>

<p>参考:
<a href="http://m.oschina.net/blog/161387">http://m.oschina.net/blog/161387</a></p>

<h1>4.Spring AOP代理</h1>

<p>Spring AOP使用JDK动态代理或者CGLIB来为目标对象创建代理。</p>

<p>如果被代理的目标对象实现了至少一个接口,则会使用JDK动态代理。所有该目标类型实现的接口都将被代理。 若该目标对象没有实现任何接口,则创建一个CGLIB代理。</p>

<p>如果你希望强制使用CGLIB代理,(例如：希望代理目标对象的所有方法,而不只是实现自接口的方法) 那也可以。但是需要考虑以下问题:</p>

<pre><code>1.无法通知(advise)final方法,因为他们不能被覆写。
2.代理对象的构造器会被调用两次。因为在CGLIB代理模式下每一个代理对象都会 产生一个子类。每一个代理实例会生成两个对象：实际代理对象和它的一个实现了通知的子类实例 而是用JDK代理时不会出现这样的行为。通常情况下,调用代理类型的构造器两次并不是问题, 因为除了会发生指派外没有任何真正的逻辑被实现。
3.CGLib的效率没有使用JDK代理机制高,速度平均要慢8倍左右。
</code></pre>

<p>强制使用CGLIB代理需要将&lt;aop:config>的proxy-target-class属性设为true:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;aop:config proxy-target-class="true"&gt;
</span><span class='line'>   ...
</span><span class='line'>&lt;/aop:config&gt;</span></code></pre></td></tr></table></div></figure>


<p>当使用@AspectJ自动代理时要强制使用CGLIB,请将&lt;aop:aspectj-autoproxy>的proxy-target-class属性设置为true:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;aop:aspectj-autoproxy proxy-target-class="true"/&gt;</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/28/cratehuan-jing-da-jian/">Crate环境搭建</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-28T01:42:15+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>1.Crate简介</h1>

<p>最近工作中使用Crate来做搜索.总结工作中Crate的知识.</p>

<p>官方网站:<a href="https://crate.io/">https://crate.io/</a></p>

<h1>2.Crate安装要求</h1>

<p>Crate最低版本要求Java 7,并且Crate的所有节点和客户端需要使用相同的JVM版本.
并且Java 7要求update 55或者之后的版本,Java 8则要求update 20或者之后的版本.</p>

<p>警告:JAVA 7之前的版本会造成脏数据和数据丢失.</p>

<h1>3.Crate安装</h1>

<p>这里选择最基本的通过下载tar.gz安装包的形式安装,还可以通过Docker等形式安装</p>

<p>详见:<a href="https://crate.io/docs/en/latest/installation.html">https://crate.io/docs/en/latest/installation.html</a></p>

<h3>3.1.下载</h3>

<p>从下面的url下载最新的稳定版本:
<a href="https://crate.io/download/">https://crate.io/download/</a></p>

<p>所有可下载版本见:
<a href="https://cdn.crate.io/downloads/releases/">https://cdn.crate.io/downloads/releases/</a></p>

<p>这里下载的是0.47.7版本:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://cdn.crate.io/downloads/releases/crate-0.47.7.tar.gz --no-check-certificate</span></code></pre></td></tr></table></div></figure>


<h3>3.2.解压</h3>

<p>自动生成crate-0.47.7目录</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /home/work
</span><span class='line'>sudo tar zxf ~/crate-0.47.7.tar.gz</span></code></pre></td></tr></table></div></figure>


<h1>4.Crate配置</h1>

<p>Crate配置参考:
<a href="https://crate.io/docs/en/latest/configuration.html">https://crate.io/docs/en/latest/configuration.html</a></p>

<p>Crate的有一套默认配置,通常情况下不需要额外的配置.</p>

<p>Crate的配置主要通过config/crate.yml文件,下载中的config/crate.yml包含了所有的配置项,包括其默认值和注释.</p>

<p>启动Crate的时候可以指定自己的配置文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./bin/crate -Des.config=/path/to/config.yml</span></code></pre></td></tr></table></div></figure>


<p>任何配置都可以在配置文件中指定或者作为启动时候的系统属性.比如据群名称的设置可以在启动时设置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./bin/crate -Des.cluster.name=cluster</span></code></pre></td></tr></table></div></figure>


<p>也可以在配置文件中配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cluster.name = cluster</span></code></pre></td></tr></table></div></figure>


<p>配置的优先级如下,越往后优先级越大(即后面的配置会覆盖前面的配置):</p>

<pre><code>1.internal defaults
2.system properties
3.options from config file
4.command-line properties
</code></pre>

<h3>4.1 基本配置</h3>

<p>一些基本的配置,工作目录和机器列表等:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>path.data: /home/work/crate/data
</span><span class='line'>path.work: /home/work/crate/work
</span><span class='line'>path.logs: /home/work/crate/logs
</span><span class='line'>
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.timeout: 6s
</span><span class='line'>discovery.zen.ping.multicast.enabled: false
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["192.168.1.100:4300", "192.168.1.101:4300", "192.168.1.102:4300"]
</span><span class='line'>discovery.zen.fd.ping_interval: 10s
</span><span class='line'>
</span><span class='line'>cluster.name: crate1
</span><span class='line'>transport.tcp.port: 4300
</span><span class='line'>http.port: 4200</span></code></pre></td></tr></table></div></figure>


<h1>5.Crate运行</h1>

<h3>5.1.启动</h3>

<p>在前台运行(可以通过Control-C中断其运行):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ./crate-0.47.7
</span><span class='line'>./bin/crate</span></code></pre></td></tr></table></div></figure>


<p>加上-d参数让crate在后台运行.</p>

<h3>5.2.Crash</h3>

<p>bin下面还包含Crash(The Crate Shell),需要python环境运行,可以通过这个Crash输入诸如sql等命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[/workspace/crate/bin]$ ./crash
</span><span class='line'>...
</span><span class='line'>CONNECT OK
</span><span class='line'>cr&gt; select count(1) from test;
</span><span class='line'>+----------+
</span><span class='line'>| count(1) |
</span><span class='line'>+----------+
</span><span class='line'>|   522835 |
</span><span class='line'>+----------+
</span><span class='line'>SELECT 1 row in set (0.032 sec)</span></code></pre></td></tr></table></div></figure>


<h3>5.3.Admin</h3>

<p>Crate同时也提供了一个基于web的administration接口.在端口4200上提供服务,可以在浏览器中通过机器名访问:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://host1.example.com:4200/_plugin/crate-admin/#/console</span></code></pre></td></tr></table></div></figure>


<p>这个Admin在Crate的每个节点上都可以运行.</p>

<h1>6.Crate安装简单示例</h1>

<p>这里使用3台机器搭建Crate集群,假设三台机器的IP如下:</p>

<pre><code>host1.example.com    192.168.1.100
host2.example.com    192.168.1.101
host3.example.com    192.168.1.102
</code></pre>

<p>每台机器上做相同的工作:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1.将Crate下载到自己的目录
</span><span class='line'>wget https://cdn.crate.io/downloads/releases/crate-0.47.7.tar.gz --no-check-certificate
</span><span class='line'>
</span><span class='line'>2.解压
</span><span class='line'>cd /home/work
</span><span class='line'>sudo tar zxf ~/crate-0.47.7.tar.gz
</span><span class='line'>
</span><span class='line'>3.创建Crate工作目录
</span><span class='line'>cd /home/work
</span><span class='line'>sudo mkdir crate
</span><span class='line'>cd crate
</span><span class='line'>sudo mkdir data
</span><span class='line'>sudo mkdir logs
</span><span class='line'>sudo mkdir work
</span><span class='line'>
</span><span class='line'>4.修改基本配置(/config/crate.yml文件)
</span><span class='line'>path.data: /home/work/crate/data
</span><span class='line'>path.work: /home/work/crate/work
</span><span class='line'>path.logs: /home/work/crate/logs
</span><span class='line'>
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.timeout: 6s
</span><span class='line'>discovery.zen.ping.multicast.enabled: false
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["192.168.1.100:4300", "192.168.1.101:4300", "192.168.1.102:4300"]
</span><span class='line'>discovery.zen.fd.ping_interval: 10s
</span><span class='line'>
</span><span class='line'>5.配置内存大小(/bin/crate文件)
</span><span class='line'>CRATE_HEAP_SIZE=4g
</span><span class='line'>
</span><span class='line'>6.启动Crate
</span><span class='line'>sudo /home/work/crate-0.47.7/bin/crate -d
</span><span class='line'>
</span><span class='line'>7.查看启动日志
</span><span class='line'>tail -f /home/work/crate/logs/crate.log</span></code></pre></td></tr></table></div></figure>


<p>三台机器都启动了,它们之间会相互感应,形成一个集群.</p>

<h1>7.Crate SQL</h1>

<p>crate的sql操作和mysql基本一致,详细可以参考:
<a href="https://crate.io/docs/en/latest/sql/index.html">https://crate.io/docs/en/latest/sql/index.html</a></p>

<h1>8.Crate运维脚本</h1>

<p>因为dev环境需求,搭建了6套dev的crate环境,发现每次启动停止crate比较麻烦,因此自己写了点基本的维护脚本,只适用于我当前的环境,即在/home/q/crate_workspace下存在6套环境,其他环境可以根据情况自行修改使用:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>drwxr-xr-x 4 root root 4096 Apr 28 17:37 crate1
</span><span class='line'>drwxr-xr-x 4 root root 4096 Apr 28 17:37 crate2
</span><span class='line'>drwxr-xr-x 4 root root 4096 Apr 28 17:37 crate3
</span><span class='line'>drwxr-xr-x 4 root root 4096 Apr 30 11:25 crate4
</span><span class='line'>drwxr-xr-x 4 root root 4096 Apr 28 17:37 crate5
</span><span class='line'>drwxr-xr-x 4 root root 4096 Apr 28 17:37 crate6
</span><span class='line'>-rwxr-xr-x 1 root root   53 Apr 28 15:41 restart_crate.sh
</span><span class='line'>-rwxr-xr-x 1 root root  724 Apr 28 16:31 start_crate.sh
</span><span class='line'>-rwxr-xr-x 1 root root 1041 Apr 28 17:15 stop_crate.sh</span></code></pre></td></tr></table></div></figure>


<p>每套环境之下有自己的配置(crate-source)和工作目录(crate)和一个存放crate线程id的文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>drwxr-xr-x 6 root root 4096 Apr 28 15:05 crate
</span><span class='line'>drwxr-xr-x 6 root root 4096 Apr 28 15:54 crate-source
</span><span class='line'>-rw-r--r-- 1 root root    5 Apr 28 17:37 pid</span></code></pre></td></tr></table></div></figure>


<p>脚本如下,启动crate的脚本start_crate.sh:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>if echo $1 | grep -q "/home/q/crate_workspace"
</span><span class='line'>then
</span><span class='line'>    export CRATE_BASE=${1%/}
</span><span class='line'>else
</span><span class='line'>    export CRATE_BASE=/home/q/crate_workspace/${1%/}
</span><span class='line'>fi
</span><span class='line'>echo -e $CRATE_BASE
</span><span class='line'>
</span><span class='line'>if ! [ -e $CRATE_BASE/crate-source/bin/crate ]
</span><span class='line'>then
</span><span class='line'>    echo -e " usage: $0 home/q/crate_workspace/CRATE_DIR\n"
</span><span class='line'>    exit 1;
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>if [ -e $CRATE_BASE/pid ]
</span><span class='line'>then
</span><span class='line'>    CRATE_ID=`cat $CRATE_BASE/pid`
</span><span class='line'>    echo "crate(${CRATE_ID}) still running now , please shutdown it firest";
</span><span class='line'>    exit 2;
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>#CRATE_START_LOG=`$CRATE_BASE/crate-source/bin/crate -p $CRATE_BASE/pid -d`
</span><span class='line'>$CRATE_BASE/crate-source/bin/crate -p $CRATE_BASE/pid -d
</span><span class='line'>
</span><span class='line'>if [ "$?" = "0" ]; then
</span><span class='line'>    echo "$0 ${1%/} start succeed"
</span><span class='line'>else
</span><span class='line'>    echo "$0 ${1%/} start failed"
</span><span class='line'>    echo $CRATE_START_LOG
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>停止crate的脚本stop_crate.sh:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>if echo $1 | grep -q "/home/q/crate_workspace"
</span><span class='line'>then
</span><span class='line'>    export CRATE_BASE=${1%/}
</span><span class='line'>else
</span><span class='line'>    export CRATE_BASE=/home/q/crate_workspace/${1%/}
</span><span class='line'>fi
</span><span class='line'>echo -e $CRATE_BASE
</span><span class='line'>
</span><span class='line'>if ! [ -e $CRATE_BASE/crate-source/bin/crate ]
</span><span class='line'>then
</span><span class='line'>    echo -e " usage: $0 home/q/crate_workspace/CRATE_DIR\n"
</span><span class='line'>    exit 1;
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>if ! [ -e $CRATE_BASE/pid ]
</span><span class='line'>then
</span><span class='line'>    echo "crate instance not found : ${1%/}";
</span><span class='line'>    exit;
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>CRATE_ID=`cat $CRATE_BASE/pid`
</span><span class='line'>
</span><span class='line'>for i in {1..10}; do
</span><span class='line'>    if [ -e $CRATE_BASE/pid ]; then
</span><span class='line'>        CRATE_ID=`cat $CRATE_BASE/pid`
</span><span class='line'>        if [ "$i" = "1" ]; then
</span><span class='line'>            echo -n "trying stop ($CRATE_ID): $i"
</span><span class='line'>        else
</span><span class='line'>            echo -n -e "\b$i"
</span><span class='line'>        fi
</span><span class='line'>        
</span><span class='line'>        if [ $i -ge 5 ]; then
</span><span class='line'>            kill "$CRATE_ID"
</span><span class='line'>            rm -f "$CRATE_BASE/pid"
</span><span class='line'>        fi
</span><span class='line'>
</span><span class='line'>        sleep 1 
</span><span class='line'>    else
</span><span class='line'>        if [ $i -gt 5 ]; then
</span><span class='line'>            echo -e "\n$CRATE_BASE was killed($i)"
</span><span class='line'>        else
</span><span class='line'>            echo -e "\n$CRATE_BASE was stoped"
</span><span class='line'>        fi
</span><span class='line'>
</span><span class='line'>        exit;
</span><span class='line'>    fi
</span><span class='line'>done;
</span><span class='line'>
</span><span class='line'>kill -9 "$CRATE_ID"
</span><span class='line'>
</span><span class='line'>echo "$CRATE_BASE was force killed"</span></code></pre></td></tr></table></div></figure>


<p>重启crate的脚本restart_crate.sh:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>./stop_crate.sh $1
</span><span class='line'>
</span><span class='line'>./start_crate.sh $1</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/11/telnet-dubbo/">Telnet Dubbo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-11T03:10:33+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Dubbo 2.0.5版本以后支持telnet命令，可以用来debug各个dubbo接口。</p>

<p>Dubbo官网：<a href="http://dubbo.io/User+Guide-zh.htm">http://dubbo.io/User+Guide-zh.htm</a></p>

<p>telnet涉及的命令包括：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ls
</span><span class='line'>ps
</span><span class='line'>cd
</span><span class='line'>pwd
</span><span class='line'>trace
</span><span class='line'>count
</span><span class='line'>invoke
</span><span class='line'>status
</span><span class='line'>log
</span><span class='line'>help
</span><span class='line'>clear
</span><span class='line'>exit</span></code></pre></td></tr></table></div></figure>


<h1>1.telnet</h1>

<p>连接dubbo的provider：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>telnet 127.0.0.1 20880</span></code></pre></td></tr></table></div></figure>


<h1>2.ls</h1>

<p>ls显示服务列表,ls -l显示服务详细信息列表:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;ls
</span><span class='line'>Xxx.xx.xxx.service.ConsumerMessageHandler
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>ls XxxService显示服务的方法列表，ls -l XxxService显示服务的方法详细信息列表</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ls -l Xxx.xx.xxx.service.ConsumerMessageHandler</span></code></pre></td></tr></table></div></figure>


<h1>3.ps</h1>

<p>ps显示服务端口列表，ps -l显示服务地址列表(ip + 端口)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;ps -l
</span><span class='line'>dubbo://10.100.11.222:30003</span></code></pre></td></tr></table></div></figure>


<p>ps 20880显示端口上的连接信息，ps -l 20880显示端口上的连接详细信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;ps -l 20880
</span><span class='line'>/127.0.0.1:51478 -&gt; /127.0.0.1:20880
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h1>4.cd</h1>

<p>改变缺省服务，当设置了缺省服务，凡是需要输入服务名作为参数的命令，都可以省略服务参数。</p>

<p>cd /可以取消缺省服务</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;cd Xxx.xx.xxx.service.ConsumerMessageHandler 
</span><span class='line'>Used the Xxx.xx.xxx.service.ConsumerMessageHandler as default.
</span><span class='line'>You can cancel default service by command: cd /</span></code></pre></td></tr></table></div></figure>


<h1>5.pwd</h1>

<p>显示当前缺省服务</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;pwd
</span><span class='line'>Xxx.xx.xxx.service.ConsumerMessageHandler
</span><span class='line'>
</span><span class='line'>dubbo&gt;cd /
</span><span class='line'>Cancelled default service qunar.tc.qmq.service.ConsumerMessageHandler.
</span><span class='line'>
</span><span class='line'>dubbo&gt;pwd 
</span><span class='line'>/</span></code></pre></td></tr></table></div></figure>


<h1>6.trace</h1>

<p>trace用来跟踪调用情况，当响应的Service的方法被调有，就会有调用日志：</p>

<pre><code>trace XxxService                跟踪1次服务任意方法的调用情况
trace XxxService 10             跟踪10次服务任意方法的调用情况
trace XxxService xxxMethod      跟踪1次服务方法的调用情况
trace XxxService xxxMethod 10   跟踪10次服务方法的调用情况
</code></pre>

<h1>7.count</h1>

<pre><code>count XxxService                统计1次服务任意方法的调用情况。
count XxxService 10             统计10次服务任意方法的调用情况。
count XxxService xxxMethod      统计1次服务方法的调用情况。
count XxxService xxxMethod 10   统计10次服务方法的调用情况。
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;count Xxx.xx.xxx.service.ConsumerMessageHandler
</span><span class='line'>dubbo&gt;
</span><span class='line'>+-------------------+-------+--------+--------+---------+-----+
</span><span class='line'>| method            | total | failed | active | average | max |
</span><span class='line'>+-------------------+-------+--------+--------+---------+-----+
</span><span class='line'>| queryMessageState | 0     | 0      | 0      | 0ms     | 0ms |
</span><span class='line'>| handle            | 0     | 0      | 0      | 0ms     | 0ms |
</span><span class='line'>+-------------------+-------+--------+--------+---------+-----+</span></code></pre></td></tr></table></div></figure>


<h1>8.invoke</h1>

<pre><code>调用服务的某个方法:  invoke XxxService.xxxMethod({"prop": "value"})
调用服务的方法(自动查找包含此方法的服务):  invoke xxxMethod({"prop": "value"})
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>invoke Xxx.xx.xxx.service..batchGetExpiredList({"batch":1})</span></code></pre></td></tr></table></div></figure>


<h1>9.status</h1>

<pre><code>status:显示汇总状态，该状态将汇总所有资源的状态，当全部OK时则显示OK，只要有一个ERROR则显示ERROR，只要有一个WARN则显示WARN

status -l:显示状态列表。
</code></pre>

<p>所有的资源包括:</p>

<pre><code>load        cpu数据,包括当前load,cpu核数
server      ip+port的列表(ps -l的数据)
datasource  数据库连接参数
threadpool  线程池参数
memory      当前JVM的内存使用情况(max,used,free)
registry    注册中心参数
spring      spring的配置文件
summary     上面这些信息中出现的Error等信息的汇总
</code></pre>

<p>示例如下
+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+
| resource   | status | message                          |
+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+
| load       | OK     | load:0.61,cpu:4                  |
| spring     | OK     | classpath:applicationContext.xml |
| summary    | ERROR  | registry                         |
+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+</p>

<h1>10.log</h1>

<p>2.0.6以上版本支持</p>

<pre><code>log  error:     修改dubbo logger的日志级别
log 100:        查看file logger的最后100字符的日志
</code></pre>

<h1>11.help</h1>

<pre><code>help        显示telnet命帮助信息
help Xxx    显示xxx命令的详细帮助信息
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dubbo&gt;help 
</span><span class='line'>Please input "help [command]" show detail.
</span><span class='line'> log level                        - Change log level or show log 
</span><span class='line'> pwd                              - Print working default service.
</span><span class='line'> trace [service] [method] [times] - Trace the service.
</span><span class='line'> clear [lines]                    - Clear screen.
</span><span class='line'> exit                             - Exit the telnet.
</span><span class='line'> help [command]                   - Show help.
</span><span class='line'> info                             - show dubbo info
</span><span class='line'> ls [-l] [service]                - List services and methods.
</span><span class='line'> invoke [service.]method(args)    - Invoke the service method.
</span><span class='line'> ps [-l] [port]                   - Print server ports and connections.
</span><span class='line'> cd [service]                     - Change default service.
</span><span class='line'> status [-l]                      - Show status.
</span><span class='line'> count [service] [method] [times] - Count the service.</span></code></pre></td></tr></table></div></figure>


<h1>12.clear</h1>

<pre><code>clear           清除屏幕上的内容
clear 100       清除屏幕上的指定行数的内容
</code></pre>

<h1>13.exit</h1>

<pre><code>exit    退出当前telnet命令行。
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <div class="panel-heading">
    <h1 class="panel-title">最新文章</h3>
  </div>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/08/20/cratewen-dang-fan-yi/">Crate文档翻译</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/22/%5B%3F%5D-ge-si-suo-wen-ti/">一个死锁问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/15/cong-dai-li-dao-springshi-wu-aop/">从代理到Spring事务2-AOP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/07/springshi-wu/">从代理到Spring事务3-Spring事务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/06/activitiru-men/">Activiti入门</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/11/cong-dai-li-dao-springshi-wu/">从代理到Spring事务1-代理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/03/strace/">Strace</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/28/who-eat-jvms-memory/">Who Eats JVM's Memory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/22/protocol-buffers/">Protocol Buffers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/23/memcachedcun-chu-mei-ju/">Memcached存储枚举</a>
      </li>
    
  </ul>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">文章分类</h1>
  </div>
  <div id="categories_list_div" class="list-group">
    <li><a class='list-group-item' href='/blog/categories/algorithm/'>algorithm (5)</a></li>
<li><a class='list-group-item' href='/blog/categories/druid/'>druid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/dubbo/'>dubbo (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/guava/'>guava (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/java/'>java (24)</a></li>
<li><a class='list-group-item' href='/blog/categories/library/'>library (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/linux/'>linux (13)</a></li>
<li><a class='list-group-item' href='/blog/categories/maven/'>maven (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/memcached/'>memcached (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/mybatis/'>mybatis (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/mysql/'>mysql (12)</a></li>
<li><a class='list-group-item' href='/blog/categories/octopress/'>octopress (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/postgresql/'>postgresql (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/protocol/'>protocol (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/qa/'>qa (2)</a></li>
<li><a class='list-group-item' href='/blog/categories/reading/'>reading (7)</a></li>
<li><a class='list-group-item' href='/blog/categories/search/'>search (9)</a></li>
<li><a class='list-group-item' href='/blog/categories/spring/'>spring (6)</a></li>
<li><a class='list-group-item' href='/blog/categories/squid/'>squid (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/structure/'>structure (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tomcat/'>tomcat (3)</a></li>
<li><a class='list-group-item' href='/blog/categories/tools/'>tools (8)</a></li>
<li><a class='list-group-item' href='/blog/categories/web/'>web (1)</a></li>
<li><a class='list-group-item' href='/blog/categories/workflow/'>workflow (1)</a></li>
 
  </div>
</section>
<section class="panel panel-default">
  <div  class="panel-heading">
    <h1 class="panel-title">友情链接</h3>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://wenzhang.baidu.com/'>百度文章</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://youdang.github.io/'>Youdang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://blog.csdn.net/ghsau'>Gaoshuang's Blog</a>
  </div>
  <div id="categories_list_div" class="list-group">
    <a class='list-group-item' href='http://kriszhang.com/'>kriszhang's Blog</a>
  </div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - xiaobaoqiu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







<!--  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> -->





</body>
</html>
